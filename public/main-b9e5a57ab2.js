window.Cipressus=function(){var e={globalTarget:null,db:{},storage:{},users:{},hardware:{}};return e.db.config={apiKey:"AIzaSyAHpgtsZeQbcoCbKNE1dNjd7gUbSIFWz6M",authDomain:"cipressus-0000.firebaseapp.com",databaseURL:"https://cipressus-0000.firebaseio.com",projectId:"cipressus-0000",storageBucket:"cipressus-0000.appspot.com",messagingSenderId:"927588929794",publicvapidkey:"BF0sMjIt0y1H_3oyJzmkBmPkrG9UK7HL5ekgRXj50jEYc3MZSfpjCd051A0tNkNfEtLmmVlYILFvi8PQ0BDXRNM"},e.db.listen=function(e,n,t){firebase.database().ref(e).on("value",function(e){n(e.val(),e.key)},function(e){t(e)})},e.db.listenChild=function(e,n,t,o,r){firebase.database().ref(e).orderByChild(n).equalTo(t).on("child_added",function(e){o(e.val(),e.key)},function(e){r(e)})},e.db.stopListener=function(e){firebase.database().ref(e).off()},e.db.get=function(e){return new Promise(function(n,t){firebase.database().ref(e).once("value").then(function(e){return n(e.val())})["catch"](function(e){return t(e)})})},e.db.getSorted=function(e,n){return new Promise(function(t,o){firebase.database().ref(e).orderByChild(n).once("value").then(function(e){return t(e)})["catch"](function(e){return o(e)})})},e.db.query=function(e,n,t){return new Promise(function(o,r){firebase.database().ref(e).orderByChild(n).equalTo(t).once("value").then(function(e){return o(e)})["catch"](function(e){return r(e)})})},e.db.set=function(e,n){return new Promise(function(t,o){firebase.database().ref(n).set(e).then(function(e){return t(e)})["catch"](function(e){return o(e)})})},e.db.update=function(e,n){return new Promise(function(t,o){firebase.database().ref(n).update(e).then(function(e){return t(e)})["catch"](function(e){return o(e)})})},e.db.push=function(e,n){return new Promise(function(t,o){firebase.database().ref(n).push(e).then(function(e){return t(e)})["catch"](function(e){return o(e)})})},e.db.pushMultiple=function(e,n){return new Promise(function(t,o){var r=[];for(var i in e)r.push(firebase.database().ref(n).push(e[i]));Promise.all(r).then(function(e){return t(e)})["catch"](function(e){return o(e)})})},e.storage.put=function(e,n,t){return new Promise(function(o,r){firebase.storage().ref().child(n+"/"+t).put(e).then(function(e){var n=e.totalBytes;e.ref.getDownloadURL().then(function(e){return o({size:n,url:e})})})["catch"](function(e){return r(e)})})},e.storage.putMultiple=function(e,n,t){return new Promise(function(o,r){var i=[];for(var a in e)i.push(firebase.storage().ref().child(n+"/"+t[a]).put(e[a]));Promise.all(i).then(function(e){var n=[],t=[];for(var r in e)t.push(e[r].totalBytes),n.push(e[r].ref.getDownloadURL());Promise.all(n).then(function(e){return o({sizes:t,urls:e})})})["catch"](function(e){return r(e)})})},e.storage.putString=function(e,n,t){return new Promise(function(o,r){firebase.storage().ref().child(n+"/"+t).putString(e).then(function(e){e.ref.getDownloadURL().then(function(e){return o(e)})})["catch"](function(e){return r(e)})})},e.storage["delete"]=function(e,n){return new Promise(function(t,o){firebase.storage().ref().child(n+"/"+e)["delete"]().then(function(){return t("Borrado: "+n+"/"+e)})["catch"](function(e){return o(e)})})},e.users.onUserSignedIn=function(e){console.log("default -- logged in "+e)},e.users.onUserSignedOut=function(){console.log("default -- logged out")},e.users.signIn=function(e){return new Promise(function(n,t){firebase.auth().signInWithEmailAndPassword(e.email,e.password)["catch"](function(e){var n,o=e.code;switch(o){case"auth/wrong-password":n="La contraseña es incorrecta.";break;case"auth/user-disabled":n="El usuario se haya inhabilitado momentáneamente.";break;case"auth/invalid-email":n="El email no es válido. Quizá esté mal escrito o no exista.";break;case"auth/user-not-found":n="El usuario no existe.";break;default:n="Algo pasó.. revisa tu conexión a internet e intentálo nuevamente."}return t([o,n])}).then(function(e){return n("Logeado correctamente.")})})},e.users.signOut=function(){return new Promise(function(e,n){firebase.auth().signOut().then(function(){return e("Ha salido de Cipressus.")})["catch"](function(e){return n([e,"Algo pasó.. intentálo nuevamente."])})})},e.users.signUp=function(n){return new Promise(function(t,o){firebase.auth().createUserWithEmailAndPassword(n.email,n.password)["catch"](function(e){var n,t=e.code;switch(t){case"auth/weak-password":n="La contraseña es demasiado débil. Intenta con una más segura.";break;case"auth/email-already-in-use":n="Éste email ya existe en nuestra base de datos.";break;case"auth/invalid-email":n="El email no es válido. Revisa lo ingresado.";break;case"auth/operation-not-allowed":n="No se puede crear la cuenta para ese usuario. Ponete en contacto con los administradores.";break;default:n="Algo pasó... revisa tu conexión a internet e intentálo nuevamente."}return o([t,n])}).then(function(r){var i={activity:{last_login:Date.now(),browser:{},os:{}},name:n.name,secondName:n.secondName,email:n.email,degree:n.degree,lu:n.lu,avatar:"images/robohashes/robohash"+Math.floor(20*Math.random()+1)+".png"};i.activity.browser[is.firefox()?"Firefox":is.chrome()?"Chrome":is.ie()?"IE":is.opera()?"Opera":is.safari()?"Safari":"Otro"]=1,i.activity.os[is.ios()?"IOS":is.android()?"Android":is.windows()?"Windows":is.linux()?"Linux":"Otro"]=1,e.db.set(i,"users_public/"+r.user.uid).then(function(o){return e.db.query("users_private","admin",!0).then(function(t){var o={icon:"info",link:"users",title:"Nuevo registro",text:"Nuevo usuario registrado: "+n.email},r=t.val();for(var i in r)e.utils.sendNotification(i,o)})["catch"](function(e){console.log(e)}),t("Datos de nuevo usuario registrados.")})["catch"](function(e){return o([e,"Ocurrió un problema al guardar los datos."])})})})},e.users.resetPwd=function(e){return new Promise(function(n,t){firebase.auth().sendPasswordResetEmail(e).then(function(){return n("Listo. Revisa tu correo electrónico.")})["catch"](function(e){return t([e,"Algo pasó.. intentálo nuevamente."])})})},e.initialize=function(){return new Promise(function(n,t){firebase.initializeApp(e.db.config);var o=firebase.messaging();return o.usePublicVapidKey(e.db.config.publicvapidkey),o.requestPermission().then(function(){console.log("Permisos de notificación otorgados.")})["catch"](function(e){console.log(e),console.log("No es posible habilitar notificaciones.")}),o.onMessage(function(n){console.log("Message received: ",n);const t={body:'Se actualizó tu calificación "Informe laboratorio 1"',icon:"/images/mainlogo.png",sound:"/sounds/notification.mp3"};e.registration.showNotification("Cipressus",t)}),o.getToken().then(function(e){e?console.log("Current token",e):console.log("No Instance ID token available. Request permission to generate one.")})["catch"](function(e){console.log("An error occurred while retrieving token. ",e)}),o.onTokenRefresh(function(){o.getToken().then(function(e){console.log("Token refreshed.")})["catch"](function(e){console.log("Unable to retrieve refreshed token ",e),showToken("Unable to retrieve refreshed token ",e)})}),navigator.serviceWorker.getRegistration().then(function(n){e.registration=n}),firebase.auth().onAuthStateChanged(function(n){n?e.users.onUserSignedIn(n.uid):e.users.onUserSignedOut()}),n()})},e}();
!function(e){var t=[];e.utils={},e.utils.searchNode=function(t,n){var i=null;if(t.id==n)return t;if(t.children)for(var r in t.children)if(i=e.utils.searchNode(t.children[r],n))return i;return i},e.utils.getLeafNodes=function(t){var n=[];if(t.children){for(var i in t.children){var r=e.utils.getLeafNodes(t.children[i]);n=n.concat(r)}return n}return[t]},e.utils.defaultCostFunction=function(e,t,n){return Math.ceil((e-t)/864e5)*n},e.utils.eval=function(t,n){var i=0,r=0;if(n.deadline&&t.submits&&t.submits[n.id]&&t.submits[n.id].submitted>n.deadline.date&&(r=e.utils.defaultCostFunction(t.submits[n.id].submitted,n.deadline.date,n.deadline.param),r>n.score&&(r=n.score)),n.children)for(var o in n.children){var s=e.utils.eval(t,n.children[o]);i+=s.score,r+=s.disc}else if(t.scores&&t.scores[n.id]){var a=t.scores[n.id].score*n.score/100;i=a}return i-=r,0>i&&(i=0),{score:i,disc:r}},e.utils.getArray=function(e){var t=function(e,n,i){if(e.children){for(var r in e.children)t(e.children[r],n,e.id);n.push({id:e.id,parent:i,name:e.name,score:e.score,dl:e.deadline})}else n.push({id:e.id,parent:i,name:e.name,value:e.score,dl:e.deadline})},n=[];return t(e,n,""),n},e.utils.getTree=function(e){var t=function(e,n,i,r){if(n.push({id:e.id,label:e.name+"\nPuntaje: "+e.score,shape:"box",color:r?r:"#555555",font:{size:12,color:"white",face:"arial",strokeWidth:3,strokeColor:"#000000"}}),e.children){var r="#"+Math.floor(16777215*Math.random()).toString(16);for(var o in e.children)t(e.children[o],n,i,r),i.push({from:e.id,to:e.children[o].id})}},n=[{id:"main",label:e.course.name.replace(/\s/g,"\n"),shape:"box",font:{size:12,color:"white",face:"arial",strokeWidth:3,strokeColor:"#000000"}}],i=[{from:"main",to:e.id}];return t(e,n,i),{nodes:n,edges:i}},e.utils.sendEmail=function(e){return new Promise(function(e,t){return t("Email no implementado")})},e.utils.sendFCMNotification=function(e){var t=new XMLHttpRequest,n="https://fcm.googleapis.com/fcm/send";t.open("POST",n,!0),t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("Authorization","key=AAAA1_ib0QI:APA91bHVFpFU4-CAibNhNmCriYbWcqbmhQuuCZa1sITD4BgF2wBBYZ8-WPc30NI0n_HfPFHEIzG1THqKgtWS8gd1bUROftZpW_o2OqBP64IgciaQMNnp4_nKU5vysZmAACjToKWFsPGe"),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);console.log(e)}};var i=JSON.stringify(e);t.send(i)},e.utils.sendNotification=function(t,n){var i=n;i.uid=t,i.timestamp=Date.now(),i.read=!1,e.db.push(i,"notifications").then(function(){console.log("Notificacion enviada")})["catch"](function(e){console.log(e)})},e.utils.generateFileName=function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;e>i;i++)t+=n.charAt(Math.floor(Math.random()*n.length));return t},e.utils.quillToHTML=function(e){return e.replace(/ql-align-center/g,"center-align")},e.utils.activityCntr=function(t,n,i){return new Promise(function(r,o){e.db.get("users_public/"+t+"/activity/items/"+n).then(function(s){var a=1;s&&(a=s+1);var c={};c["users_public/"+t+"/activity/items/"+n]=a,i?c["users_public/"+t+"/lastView"]=n+"?id="+i:c["users_public/"+t+"/lastView"]=n,e.db.update(c).then(function(e){return r(e)})["catch"](function(e){return o(e)})})["catch"](function(e){return o(e)})})},e.utils.logAction=function(e){t.push({msg:e,timestamp:Date.now()})},e.utils.logError=function(n){n.timestamp=Date.now(),t.length>0&&(n.stack=t),e.db.push(n,"errorLog").then(function(){t=[],console.log("Error reportado")})["catch"](function(e){console.log(e)})},e.utils.getPrimeImplicants=function(e){var t,n,i,r,o,s,a,c,u=function(e,t){var n,i=e.length,r="",o=0;for(n=0;i>n;n++)e[n]===t[n]?r+=e[n]:e[n]!==t[n]&&(r+="-",o+=1);return o>1?"":r},l=function(e,t){var n=[],i=function(t){n.push(e),t>1&&i(t-1)};return i(t),n},d=[].concat(e),f=d.length,h=[],m=[],p=[],g=l(0,f),v=0;for(n=0;f>n;n++)for(i=n+1;f>i;i++)r=u(d[n],d[i]),""!==r&&(m.push(r),g[n]=1,g[i]=1);for(t=l(0,m.length),o=0;o<m.length;o++)for(s=o+1;s<m.length;s++)o!==s&&0===t[s]&&m[o]===m[s]&&(t[s]=1);for(a=0;a<m.length;a++)0===t[a]&&p.push(m[a]);for(c=0;f>c;c++)0===g[c]&&(h.push(d[c]),v+=1);return v!==f&&1!==f&&(h=h.concat(Cipressus.utils.getPrimeImplicants(p))),h.sort(),h}}(Cipressus);
!function(e){var a,r=null,o=[];e.hardware.initServer=function(n){e.hardware.status="CONNECTING",e.hardware.sample_period=n.sp,e.hardware.io=n.io,e.hardware.onUpdate=n.onUpdate,a=new WebSocket("ws://localhost:8081"),a.onerror=function(e){console.log(e)},a.onopen=function(){r&&(clearInterval(r),r=null),e.hardware.onSocketOpen()},a.onclose=function(){"CONNECTED"!=e.hardware.status&&"IDLE"!=e.hardware.status||(e.hardware.status="CONNECTING"),r||(r=setInterval(function(){a=null,e.hardware.initServer(n)},n.ci)),e.hardware.onSocketClose()},a.onmessage=function(r){o=JSON.parse(r.data),e.hardware.status="IDLE",a.onmessage=function(a){for(var r=0;8>r;r++)e.hardware.io[r].input="1"==a.data[r];e.hardware.onUpdate()}}},e.hardware.stopServer=function(){e.hardware.status="DISCONNECTED",r&&(clearInterval(r),r=null),a.onclose=function(){},a.close(),a=null},e.hardware.ioUpdate=function(){var r="";for(var o in e.hardware.io)r+=e.hardware.io[o].output?"1":"0";a.send(r),"CONNECTED"==e.hardware.status&&setTimeout(e.hardware.ioUpdate,e.hardware.sample_period)},e.hardware.connectTo=function(r){o.length>0?(a.send(r),e.hardware.status="CONNECTED",setTimeout(e.hardware.ioUpdate,500)):console.log("El listado de puertos no está disponible")},e.hardware.getSerialPorts=function(){return o},e.hardware.onSocketOpen=function(){console.log("Socket abierto.")},e.hardware.onSocketClose=function(){console.log("Socket cerrado.")}}(Cipressus);
!function(e){e.test_FS={questions:[{text:"Entiendo mejor algo",options:["si lo practico.","si pienso en ello."]},{text:"Me considero",options:["realista.","innovador."]},{text:"Cuando pienso acerca de lo que hice ayer, es más probable que lo haga sobre la base de",options:["una imagen.","palabras."]},{text:"Tengo tendencia a",options:["entender los detalles de un tema pero no ver claramente su estructura completa","entender la estructura completa pero no ver claramente los detalles."]},{text:"Cuando estoy aprendiendo algo nuevo, me ayuda",options:["hablar de ello.","pensar en ello."]},{text:"Si yo fuera profesor, yo preferiría dar un curso",options:["que trate sobre hechos y situaciones reales de la vida.","que trate con ideas y teorías."]},{text:"Prefiero obtener información nueva de",options:["imágenes, diagramas, gráficas o mapas."," instrucciones escritas o información verbal."]},{text:"Una vez que entiendo",options:["todas las partes, entiendo el total.","el total de algo, entiendo como encajan sus partes."]},{text:"En un grupo de estudio que trabaja con un material difícil, es más probable que",options:["participe y contribuya con ideas.","no participe y solo escuche."]},{text:"Es más fácil para mí",options:["aprender hechos.","aprender conceptos."]},{text:"En un libro con muchas imágenes y gráficas es más probable que",options:["revise cuidadosamente las imágenes y las gráficas."," me concentre en el texto escrito."]},{text:"Cuando resuelvo problemas de matemáticas",options:["generalmente trabajo sobre las soluciones con un paso a la vez.","frecuentemente sé cuales son las soluciones, pero luego tengo dificultad para imaginarme los pasos para llegar a ellas."]},{text:"En las clases a las que he asistido",options:["he llegado a saber como son muchos de los estudiantes.","raramente he llegado a saber como son muchos estudiantes."]},{text:"Cuando leo temas que no son de ficción, prefiero",options:["algo que me enseñe nuevos hechos o me diga como hacer algo.","algo que me dé nuevas ideas en que pensar."]},{text:"Me gustan los maestros",options:["que utilizan muchos esquemas en el pizarrón.","que toman mucho tiempo para explicar."]},{text:"Cuando estoy analizando un cuento o una novela",options:["pienso en los incidentes y trato de acomodarlos para configurar los temas.","me doy cuenta de cuales son los temas cuando termino de leer y luego tengo que regresar y encontrar los incidentes que los demuestran."]},{text:"Cuando comienzo a resolver un problema de tarea, es más probable que",options:["comience a trabajar en su solución inmediatamente.","primero trate de entender completamente el problema."]},{text:"Prefiero la idea de",options:["certeza.","teoría."]},{text:"Recuerdo mejor",options:["lo que veo.","lo que oigo."]},{text:"Es más importante para mí que un profesor",options:["exponga el material en pasos secuenciales claros.","me dé un panorama general y relacione el material con otros temas."]},{text:"Prefiero estudiar",options:["en un grupo de estudio.","solo."]},{text:"Me considero",options:["cuidadoso en los detalles de mi trabajo.","creativo en la forma en la que hago mi trabajo."]},{text:"Cuando alguien me da direcciones de nuevos lugares, prefiero",options:["un mapa.","instrucciones escritas."]},{text:"Aprendo",options:["a un paso constante. Si estudio con ahínco consigo lo que deseo.","en inicios y pausas. Me llego a confundir y súbitamente lo entiendo."]},{text:"Prefiero primero",options:["hacer algo y ver que sucede.","pensar como voy a hacer algo."]},{text:"Cuando leo por diversión, me gustan los escritores que",options:["dicen claramente los que desean dar a entender.","dicen las cosas en forma creativa e interesante."]},{text:"Cuando veo un esquema o bosquejo en clase, es más probable que recuerde",options:["la imagen.","lo que el profesor dijo acerca de ella."]},{text:"Cuando me enfrento a un cuerpo de información",options:["me concentro en los detalles y pierdo de vista el total de la misma.","trato de entender el todo antes de ir a los detalles."]},{text:"Recuerdo más fácilmente",options:["algo que he hecho.","algo en lo que he pensado mucho."]},{text:"Cuando tengo que hacer un trabajo, prefiero",options:["dominar una forma de hacerlo.","intentar nuevas formas de hacerlo."]},{text:"Cuando alguien me enseña datos, prefiero",options:["gráficas.","resúmenes con texto."]},{text:"Cuando escribo un trabajo, es más probable que",options:["lo haga (piense o escriba) desde el principio y avance."," lo haga (piense o escriba) en diferentes partes y luego las ordene."]},{text:"Cuando tengo que trabajar en un proyecto de grupo, primero quiero",options:["realizar una 'tormenta de ideas' donde cada uno contribuye con ideas.","realizar la 'tormenta de ideas' en forma personal y luego juntarme con el grupo para comparar las ideas."]},{text:"Considero que es mejor elogio llamar a alguien",options:["sensible.","imaginativo."]},{text:"Cuando conozco gente en una fiesta, es más probable que recuerde",options:["cómo es su apariencia.","lo que dicen de sí mismos."]},{text:"Cuando estoy aprendiendo un tema, prefiero",options:["mantenerme concentrado en ese tema, aprendiendo lo más que pueda de él.","hacer conexiones entre ese tema y temas relacionados."]},{text:"Me considero",options:["abierto.","reservado."]},{text:"Prefiero cursos que dan más importancia a",options:["material concreto (hechos, datos)."," material abstracto (conceptos, teorías)."]},{text:"Para divertirme, prefiero",options:["ver televisión.","leer un libro."]},{text:"Algunos profesores inician sus clases haciendo un bosquejo de lo que enseñarán. Esos bosquejos son",options:["algo útiles para mí.","muy útiles para mí."]},{text:"La idea de hacer una tarea en grupo con una sola calificación para todos",options:["me parece bien.","no me parece bien."]},{text:"Cuando hago grandes cálculos",options:["tiendo a repetir todos mis pasos y revisar cuidadosamente mi trabajo.","me cansa hacer su revisión y tengo que esforzarme para hacerlo."]},{text:"Tiendo a recordar lugares en los que he estado",options:["fácilmente y con bastante exactitud.","con dificultad y sin mucho detalle."]},{text:"Cuando resuelvo problemas en grupo, es más probable que yo",options:["piense en los pasos para la solución de los problemas.","piense en las posibles consecuencias o aplicaciones de la solución en un amplio rango de campos."]}],evalMatrix:[[[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0]],[[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0]],[[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0]],[[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0]],[[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0]],[[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0]],[[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0],[0,0],[0,0],[0,0],[1,0]],[[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1],[0,0],[0,0],[0,0],[0,1]]],profileDesc:[["Aprende por interacción directa con el material de estudio. Prefiere la comunicación visual.","Le gusta reflexionar sobre el material de estudio. Prefiere el trabajo individual y comunicación grupal mínima."],["Detallista y práctico con preferencia por hechos concretos y aplicaciones del mundo real.","Creativo y se siente atraído por el contenido teórico y abstracto."],["Recuerda fácilmente imágenes que se le presenta (gráficos, fotos, esquemas, etc.).","Recuerda fácilmente frases escritas o habladas."],["Prefiere aprender de manera lineal, mediante secuencia de pasos lógicos.","Prefiere que se le presente un esquema general y luego aprende y entiende las partes por separado sin seguir un orden específico."]],eval:function(e){for(var o=[],a=0;8>a;a++){var n=[];for(var s in e)n[s]=this.evalMatrix[a][s][e[s]];o[a]=n.reduce(function(e,o){return e+o},0)}for(var t=[],r=0;8>r;r+=2)t[r/2]=o[r+1]-o[r];return t}}}(Cipressus);
var app=angular.module("cipressus",["ngRoute","ngSanitize","LocalStorageModule"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/home.html",controller:"home"}).when("/home",{templateUrl:"views/home.html",controller:"home"}).when("/login",{templateUrl:"views/login.html",controller:"login"}).when("/dashboard",{templateUrl:"views/dashboard.html",controller:"dashboard"}).when("/calendar",{templateUrl:"views/calendar.html",controller:"calendar"}).when("/sources",{templateUrl:"views/sources.html",controller:"sources"}).when("/submissions",{templateUrl:"views/submissions.html",controller:"submissions"}).when("/hardware",{templateUrl:"views/hardware.html",controller:"hardware"}).when("/analizer",{templateUrl:"views/analizer.html",controller:"analizer"}).when("/simulator",{templateUrl:"views/simulator.html",controller:"simulator"}).when("/kMaps",{templateUrl:"views/kMaps.html",controller:"kMaps"}).when("/tables",{templateUrl:"views/tables.html",controller:"tables"}).when("/videos",{templateUrl:"views/videos.html",controller:"videos"}).when("/users",{templateUrl:"views/users.html",controller:"users"}).when("/stats",{templateUrl:"views/stats.html",controller:"stats"}).when("/attendance",{templateUrl:"views/attendance.html",controller:"attendance"}).when("/activities",{templateUrl:"views/activities.html",controller:"activities"}).when("/courses",{templateUrl:"views/courses.html",controller:"courses"}).when("/editor",{templateUrl:"views/editor.html",controller:"editor"}).when("/profile",{templateUrl:"views/profile.html",controller:"profile"})}]).filter("trusted",["$sce",function(e){return e.trustAsResourceUrl}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).run(["$rootScope","$location","$sce",function(e,t,o){e.loading=!0,e.userLogged=!1,t.path("/login"),e.bodyClass="",e.notifications=[],e.notifCnt=0,moment.locale("es",{relativeTime:{future:"dentro de %s",past:"hace %s",s:"pocos segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un año",yy:"%d años"}}),e.greetings=function(){var e=12,t=19,o=parseFloat(moment().format("HH"));return o>=e&&t>=o?"Buenas tardes":o>=t?"Buenas noches":"Buenos días"},e.getTime=function(e,t){var o;switch(e){case 0:o=Date.now();break;case 1:o=moment(Date.now()).format("DD/MM/YYYY HH:mm");break;case 2:o=moment(Date.now()).format("DD/MM/YYYY");break;case 3:o=moment(t).format("DD/MM/YYYY HH:mm");break;case 4:o=moment(t).format("DD/MM/YYYY");break;case 5:o=moment(t).fromNow();break;case 6:o=moment(t).format("DD/MM HH:mm");break;default:o=null}return o},e.getUserNames=function(e,t){if(e){var o=[];for(var s in t)o.push(e[t[s]].secondName);return o.join(", ")}},e.readableFileSize=function(e,t){var o=t?1e3:1024;if(Math.abs(e)<o)return e+" B";var s=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],n=-1;do e/=o,++n;while(Math.abs(e)>=o&&n<s.length-1);return e.toFixed(1)+" "+s[n]},e.openNotification=function(o){var s=e.notifications.findIndex(function(e){return e.key==o});e.notifications[s].read||(e.notifications[s].read=!0,e.notifCnt--,Cipressus.db.update({read:!0},"notifications/"+e.notifications[s].key)),e.notifications[s].link&&t.path(e.notifications[s].link)},e.sidenav=M.Sidenav.init(document.querySelector(".sidenav"),{side:"left",inDuration:400}),M.Collapsible.init(document.querySelector(".collapsible_1")),M.Collapsible.init(document.querySelector(".collapsible_2")),M.Collapsible.init(document.querySelector(".collapsible_3")),M.Modal.init(document.getElementById("about_modal"),{});var s=M.Modal.init(document.getElementById("usb_modal"),{}),n=M.Modal.init(document.getElementById("help_modal"),{});window.addEventListener("resize",function(){e.resizeEvent&&e.resizeEvent()}),M.Dropdown.init(document.querySelectorAll(".dropdown-trigger"),{}),e.signOut=function(){t.path("/login"),e.userLogged=!1,Cipressus.db.stopListener("notifications"),Cipressus.users.signOut().then(function(t){console.log(t),e.user=null,M.toast({html:"Hasta pronto!",classes:"rounded green darken-3",displayLength:1500})})["catch"](function(e){console.log(e),M.toast({html:e[1],classes:"rounded green darken-3",displayLength:1500})})},e.sendHelp=function(){console.log(e.helpMessage),M.toast({html:"Listo! Te enviaremos una respuesta",classes:"rounded green darken-3",displayLength:2500}),n.close()},Cipressus.users.onUserSignedIn=function(s){e.loading=!0,Cipressus.db.get("users_public/"+s).then(function(n){e.user=n,e.user.uid=s,e.notifications=[],e.notifCnt=0,Cipressus.db.get("users_private/"+s).then(function(r){r?(e.user.admin=r.admin,e.user.enrolled=r.enrolled,e.user.course=r.course):(e.user.admin=!1,e.user.enrolled=null,e.user.course=null);var i=is.firefox()?"Firefox":is.chrome()?"Chrome":is.ie()?"IE":is.opera()?"Opera":is.safari()?"Safari":"Otro",a=is.ios()?"IOS":is.android()?"Android":is.windows()?"Windows":is.linux()?"Linux":"Otro",l=n.activity;if(l||(l={browser:{},os:{},last_login:0}),l.last_login=Date.now(),l.browser?l.browser[i]?l.browser[i]++:l.browser[i]=1:(l.browser={},l.browser[i]=1),l.os?l.os[a]?l.os[a]++:l.os[a]=1:(l.os={},l.os[a]=1),Cipressus.db.update(l,"users_public/"+s+"/activity").then(function(e){console.log("Actividad actualizada")}),Cipressus.db.listenChild("notifications","uid",s,function(t,o){t.key=o,e.notifications.push(t),t.read||e.notifCnt++,e.$apply()},function(e){console.log(e)}),Cipressus.db.get("metadata/discord").then(function(t){t&&(url="https://discord.com/widget?id="+t.id+"&theme="+t.theme,console.log(url),e.discordSRC=o.trustAsResourceUrl(url),e.$apply())})["catch"](function(e){console.log(e),M.toast({html:"No se pudo conectar al servidor de Discord",classes:"rounded red",displayLength:2e3})}),"/login"==t.path()){if(e.user.lastView){var c=e.user.lastView.split("?id=");c.length>1?t.path("/"+c[0]).search({id:c[1]}):t.path("/"+c[0])}else t.path("/");e.bodyClass=""}e.userLogged=!0,e.loading=!1,e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})},Cipressus.users.onUserSignedOut=function(){e.sidenav.close(),e.userLogged=!1,t.path("/login"),e.loading=!1,e.$apply()},Cipressus.initialize().then(function(){console.log("Cipressus inicializado."),e.loading=!1,e.$apply()})["catch"](function(){console.log("Error de incialización de Cipressus"),e.loading=!1,e.$apply()}),Cipressus.hardware.status="DISCONNECTED",e.usbStatus="DISCONNECTED",e.wssIconColor="red-text",e.onWssConnect=function(){},e.onWssDisconnect=function(){};var r={io:[{output:!1,input:!1},{output:!0,input:!1},{output:!1,input:!0},{output:!1,input:!0},{output:!1,input:!1},{output:!1,input:!1},{output:!0,input:!1},{output:!1,input:!0}],ci:5e3,sp:50,onUpdate:function(){}};Cipressus.hardware.onSocketClose=function(){console.log("Socket cerrado. Reconectando..."),M.toast({html:"Reconectando con server...",classes:"rounded blue darken-3",displayLength:2e3}),e.usbStatus="CONNECTING",e.wssIconColor="blue-text",e.$apply()},Cipressus.hardware.onSocketOpen=function(){console.log("Socket abierto."),e.usbStatus="IDLE",e.wssIconColor="yellow-text",e.$apply(),M.toast({html:"Server conectado",classes:"rounded blue darken-3",displayLength:2e3}),setTimeout(function(){e.serialPorts=Cipressus.hardware.getSerialPorts(),e.$apply(),M.FormSelect.init(document.querySelectorAll("select"),{}),M.toast({html:"Puertos disponibles",classes:"rounded green darken-3",displayLength:2e3})},500)},e.openUSBModal=function(){"IDLE"==Cipressus.hardware.status&&(e.serialPorts=Cipressus.hardware.getSerialPorts(),M.FormSelect.init(document.querySelectorAll("select"),{})),s.open()},e.connectToServer=function(){"DISCONNECTED"==Cipressus.hardware.status&&Cipressus.hardware.initServer(r)},e.disconnectFromServer=function(){Cipressus.hardware.stopServer(),e.enableConnect=!1,M.toast({html:"Server desconectado",classes:"rounded green darken-3",displayLength:2e3}),e.usbStatus="DISCONNECTED",e.wssIconColor="red-text",e.onWssDisconnect(),s.close()},e.connectToSerialPort=function(){Cipressus.hardware.connectTo(document.getElementById("portSelect").value),e.usbStatus="CONNECTED",e.wssIconColor="green-text",e.onWssConnect(),M.toast({html:"Probador conectado!",classes:"rounded green darken-3",displayLength:2e3}),s.close()};var i=function(){return"standalone"in window.navigator&&window.navigator.standalone};is.ios()&&!i()&&this.setState({showInstallMessage:!0}),window.addEventListener("beforeinstallprompt",function(e){e.userChoice.then(function(e){console.log(e.outcome),"dismissed"==e.outcome?console.log("User cancelled home screen install"):console.log("User added to home screen")})})}]);
app.directive("testResults",function(){return{restrict:"E",templateUrl:function(){return"views/testResults.html"},scope:{answers:"@"},link:function(e){e.$watch("answers",function(){if(e.answers)for(var t=Cipressus.test_FS.eval(JSON.parse(e.answers)),s=0;4>s;s++){var n=document.getElementById("scale_"+s),r=50*Math.abs(t[s])/11;n.style.width=r+"%",t[s]<0?(n.style.marginLeft=50-r+"%",document.getElementById("prof_"+s).innerHTML=Cipressus.test_FS.profileDesc[s][0]):(n.style.marginLeft="50%",document.getElementById("prof_"+s).innerHTML=Cipressus.test_FS.profileDesc[s][1]),n.innerHTML=Math.abs(t[s])}},!0)}}});
app.controller("login",["$scope","$rootScope",function(e,o){e.keypressed=function(o){13===o&&e.btn_click()},e.loginAttempt=function(){"undefined"!=typeof e.userForm?(o.loading=!0,Cipressus.users.signIn(e.userForm).then(function(e){console.log(e),setTimeout(function(){o.user&&M.toast({html:o.greetings()+" "+o.user.name+"!",classes:"rounded green darken-3",displayLength:5e3})},2e3),o.$apply()})["catch"](function(s){e.userForm.password=null,console.log(s[0]),M.toast({html:s[1],classes:"rounded red",displayLength:2500}),o.loading=!1,o.$apply()})):(console.log("Formulario vacío"),M.toast({html:"Debe completar el formulario!",classes:"rounded red",displayLength:2500}))},e.retrievePassword=function(){"undefined"!=typeof e.userForm?Cipressus.users.resetPwd(e.userForm.email).then(function(e){console.log(e),M.toast({html:"Listo! Te enviamos el formulario a tu correo electrónico",classes:"rounded green darken-3",displayLength:2500})})["catch"](function(e){console.log(e[0]),M.toast({html:e[1],classes:"rounded red",displayLength:2500})}):(console.log("Formulario vacío"),M.toast({html:"Debe completar el formulario!",classes:"rounded red",displayLength:2500}))},e.registerNewUser=function(){var s=!1;"undefined"!=typeof e.userForm&&(e.userForm.degree=document.getElementById("degreeSelect").value,""!=e.userForm.name&&""!=e.userForm.secondName&&"undefined"!=typeof e.userForm.lu&&""!=e.userForm.degree&&(s=!0)),s?e.userForm.password==e.passwordConfirm?Cipressus.users.signUp(e.userForm).then(function(s){console.log(s),M.toast({html:o.greetings()+" "+e.userForm.name+"!",classes:"rounded green darken-3",displayLength:2500})})["catch"](function(e){console.log(e[0]),M.toast({html:e[1],classes:"rounded red",displayLength:2500})}):(console.log("Confirmación de contraseña fallida"),M.toast({html:"Verificación de contraseña incorrecto!",classes:"rounded red",displayLength:2e3})):(console.log("Formulario incompleto"),M.toast({html:"Debe completar el formulario!",classes:"rounded red",displayLength:2500}))},e.updateButtons=function(){switch(e.login_mode){case 0:e.btn_text="Iniciar sesión",e.menu_left="Registrarse",e.menu_right="¿Olvidó su contraseña?",e.btn_click=e.loginAttempt,e.welcomeText="Iniciar sesión en ";break;case 1:e.btn_text="Registrarse",e.menu_left="¿Olvidó su contraseña?",e.menu_right="Iniciar sesión",e.btn_click=e.registerNewUser,e.welcomeText="Registrarse en ";break;case 2:e.btn_text="Recuperar contraseña",e.menu_left="Iniciar sesión",e.menu_right="Registrarse",e.btn_click=e.retrievePassword,e.welcomeText="Recuperar contraseña de "}},e.login_mode=0,e.updateButtons(),o.bodyClass="body-login",M.FormSelect.init(document.querySelectorAll("select"),{}),setTimeout(function(){M.updateTextFields()},1500)}]);
app.controller("home",["$scope","$rootScope","$location","localStorageService",function(e,s,t,n){if(!s.userLogged)return void t.path("/login");if(s.loading=!0,s.sidenav.close(),e.testFSAnswers=[],e.testStatus=0,!s.user.test_fs&&!s.user.admin&&s.user.enrolled){var o=M.Modal.init(document.getElementById("test_modal"),{dismissible:!1});e.loadTest=function(){e.test_FS=Cipressus.test_FS.questions,e.results=n.get("testFS"),e.results||(e.results={startTime:Date.now(),answers:[],timeline:[],changes:[]}),e.testStatus=1},e.putOption=function(s,t){void 0!=e.results.answers[s]&&e.results.changes.push({quest:s,prev:e.results.answers[s],next:t}),e.results.answers[s]=t,e.results.timeline[s]=(Date.now()-e.results.startTime)/1e3,n.set("testFS",e.results),44==e.results.answers.filter(function(e){return void 0!==e&&null!==e}).length&&(e.testStatus=2)},e.saveTestResults=function(){s.loading=!0,console.log(e.results),e.testFSAnswers=e.results.answers,Cipressus.db.set(e.results,"users_public/"+s.user.uid+"/test_fs").then(function(t){M.toast({html:"Gracias por tu tiempo!",classes:"rounded green darken-3",displayLength:2e3}),e.testStatus=3,s.loading=!1,e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al guardar resultados",classes:"rounded red",displayLength:2e3})})},o.open()}var r=function(){e.news=[];var t=[];s.user.course?Cipressus.db.getSorted("news/"+s.user.course,"order").then(function(o){if(o.forEach(function(s){var n=s.val();n.key=s.key,n.content=Cipressus.utils.quillToHTML(n.content),-1==t.indexOf(n.author)&&t.push(n.author);for(var o in n.comments)-1==t.indexOf(n.comments[o].uid)&&t.push(n.comments[o].uid);e.news.unshift(n)}),e.users={},t.length>0){var r=function(o){Cipressus.db.get("users_public/"+t[o]).then(function(a){e.users[t[o]]=a,o++,o==t.length?(u={news:e.news,authors:e.users,last_update:Date.now()},n.set("newsData_"+s.user.course,u),s.loading=!1,s.$apply(),setTimeout(function(){M.Dropdown.init(document.querySelectorAll(".dropdown-trigger"),{})},200)):r(o)})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})};r(0)}else s.loading=!1,s.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})}):s.loading=!1},a=M.Modal.init(document.getElementById("comment_modal"),{});e.commentText="",e.commentPost=function(s){e.commEntryIdx=s,a.open(),setTimeout(function(){M.updateTextFields()},100)},e.publishComment=function(){if(""!=e.commentText){s.loading=!0;var t={uid:s.user.uid,text:e.commentText,timestamp:Date.now()};Cipressus.db.push(t,"news/"+s.user.course+"/"+e.news[e.commEntryIdx].key+"/comments").then(function(n){e.news[e.commEntryIdx].comments||(e.news[e.commEntryIdx].comments={}),e.news[e.commEntryIdx].comments[n.key]=t,e.commentText="",e.users[s.user.uid]||(e.users[s.user.uid]=s.user);var o={};o[s.user.course]=Date.now(),Cipressus.db.update(o,"metadata/updates/news").then(function(t){M.toast({html:"Comentario publicado correctamente",classes:"rounded green",displayLength:1500}),M.Dropdown.init(document.querySelectorAll(".dropdown-trigger"),{}),s.loading=!1,a.close(),e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al publicar comentario",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al publicar comentario",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})}else M.toast({html:"El comentario está vacío!",classes:"rounded red",displayLength:1500})},e.deleteComment=function(t,n){s.loading=!0,Cipressus.db.set(null,"news/"+s.user.course+"/"+e.news[n].key+"/comments/"+t).then(function(o){delete e.news[n].comments[t];var r={};r[s.user.course]=Date.now(),Cipressus.db.update(r,"metadata/updates/news").then(function(t){M.toast({html:"Comentario eliminado",classes:"rounded green",displayLength:1500}),s.loading=!1,a.close(),e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al publicar comentario",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al publicar comentario",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})},Cipressus.utils.activityCntr(s.user.uid,"home")["catch"](function(e){console.log(e)});var u=n.get("newsData_"+s.user.course);u?(e.news=u.news,e.users=u.authors,Cipressus.db.get("metadata/updates/news/"+s.user.course).then(function(e){u.last_update<e?r():(M.Dropdown.init(document.querySelectorAll(".dropdown-trigger"),{}),s.loading=!1,s.$apply())})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,s.$apply()})):r()}]);
app.controller("dashboard",["$scope","$rootScope","$location",function(e,s,t){s.userLogged||t.path("/login"),s.loading=!0,s.sidenav.close();var r=function(e){Highcharts.chart("sunburst_container",{chart:{height:"100%"},title:{text:"Proporción de calificaciones"},credits:{enabled:!1},plotOptions:{series:{events:{click:function(e){a(e.point.node.id)}}}},series:[{type:"sunburst",data:e,allowDrillToNode:!0,cursor:"pointer",dataLabels:{format:"{point.name}",filter:{property:"innerArcLength",operator:">",value:16}},levels:[{level:1,levelIsConstant:!1,dataLabels:{filter:{property:"outerArcLength",operator:">",value:64}}},{level:2,colorIndex:1},{level:3,colorByPoint:!0},{level:4,colorVariation:{key:"brightness",to:-.5}},{level:5,colorVariation:{key:"brightness",to:.5}}]}],tooltip:{headerFormat:"",pointFormat:"La actividad <b>{point.name}</b> suma <b>{point.value}</b> puntos"}})},a=function(s){if(e.user){var t=[];e.currentNode=Cipressus.utils.searchNode(e.activities,s);var r=Cipressus.utils.eval(e.user,e.currentNode),a=r.score/e.currentNode.score*100;e.currentActivityScores={name:e.currentNode.name,points:(e.currentNode.score*a/100).toFixed(2),score:a.toFixed(2),children:[]};for(k in e.currentNode.children){var i=Cipressus.utils.eval(e.user,e.currentNode.children[k]),n=i.score/e.currentNode.children[k].score*100;e.currentActivityScores.children.push({name:e.currentNode.children[k].name,points:(e.currentNode.children[k].score*n/100).toFixed(2),score:n.toFixed(2)}),t.push({y:e.currentNode.children[k].score,z:parseInt(n.toFixed(2)),name:e.currentNode.children[k].name})}e.$apply(),Highcharts.chart("variable_pie_container",{chart:{type:"variablepie",height:"100%"},credits:{enabled:!1},title:{text:"Mis calificaciones"},tooltip:{headerFormat:"",pointFormat:'<span style="color:{point.color}">●</span> <b> {point.name}</b><br/>Nota actividad: <b>{point.z}%</b><br/>'},series:[{minPointSize:10,innerSize:"20%",zMin:0,name:"Notas",data:t}]})}},i=function(){var s=[{name:"Avance programa",y:c-l,color:"#8181F7",dataLabels:{enabled:!1}},{name:"Restantes",y:l,color:"#dddddd",dataLabels:{enabled:!1}}],t=[{name:"Presente",y:e.user.scores.asistencia.score,color:"#FF4444",dataLabels:{enabled:!1}},{name:"Ausente",y:100-e.user.scores.asistencia.score,color:"#dddddd",dataLabels:{enabled:!1}}];Highcharts.chart("progress_pie_container",{chart:{type:"pie",plotBorderWidth:0},credits:{enabled:!1},title:{text:"Mi participación"},tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{startAngle:-90,endAngle:90,center:["50%","50%"]}},series:[{name:"Asistencia",size:"70%",data:t},{name:"Progreso",innerSize:"70%",data:s}]})},n=function(){var t=[],r=[];for(var a in e.users)if(!e.users[a].admin&&e.users[a].scores&&e.users[a].course==s.user.course){t.push({name:a,y:Cipressus.utils.eval(e.users[a],e.activities).score,color:a==s.user.uid?"#FF0000":"#AAAAAA",drilldown:a});var i=[];for(var n in e.activities.children)i.push([e.activities.children[n].id,Cipressus.utils.eval(e.users[a],e.activities.children[n]).score/e.activities.children[n].score*100]);r.push({name:a==s.user.uid?"Yo":"#"+(t.length+1),id:a,data:i})}t.sort(function(e,s){return e.y<s.y?1:s.y<e.y?-1:0});for(var a in t)t[a].name=t[a].name==s.user.uid?"Yo":"#"+(parseInt(a)+1);Highcharts.setOptions({lang:{drillUpText:"<< Volver a {series.name}"}}),Highcharts.chart("barplot_container",{chart:{type:"bar"},title:{text:"Calificaciones del curso"},xAxis:{type:"category"},yAxis:{title:{text:"Puntaje acumulado"}},credits:{enabled:!1},legend:{enabled:!1},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y:.1f} pts"}}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:'<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f} pts</b>'},series:[{name:"Alumno",data:t}],drilldown:{series:r}})};e.drillUp=function(){$("#barplot_container").highcharts().drillUp()};var o=function(){var t=[],r=!0,a=[],i=0,n=0;for(var o in e.eventsAll)e.eventsAll[o].start<Date.now()&&e.eventsAll[o].attendance&&(i++,e.user.attendance[o]&&n++,0!=n?a.push(n/i*100):a.push(0),r&&t.push(s.getTime(3,e.eventsAll[o].start)));r=!1,console.log(a),Highcharts.chart("attendance_container",{chart:{type:"spline"},credits:{enabled:!1},title:{text:"Asistencia a clases"},xAxis:{categories:t},series:[{name:"Mi asistencia",data:a}]})},c=0,l=0,d=0;Cipressus.utils.activityCntr(s.user.uid,"dashboard")["catch"](function(e){console.log(e)}),Cipressus.db.get("activities/"+s.user.course).then(function(t){e.activities=t,Cipressus.db.get("users_private").then(function(t){e.users=t,e.user=t[s.user.uid],e.user&&("undefined"==typeof e.user.scores&&(e.user.scores=[]),"undefined"==typeof e.user.submits&&(e.user.submits=[]));var u=Cipressus.utils.getArray(e.activities);e.$apply(),r(u),a(e.activities.id),s.$apply(),e.events=[],Cipressus.db.getSorted("events/"+s.user.course,"start").then(function(t){e.eventsAll={},t.forEach(function(s){e.eventsAll[s.key]=s.val();var t=s.val();c++,t.start>Date.now()?(l++,e.events.length<5&&(t.side=e.events.length%2?"tl-right":"tl-left",e.events.push(t))):t.attendance&&d++});for(var r in e.users)if(e.users[r])if(e.users[r].scores)if(e.users[r].attendance){var u=Object.getOwnPropertyNames(e.users[r].attendance).length,p=d>0?u/d*100:0;e.users[r].scores.asistencia={score:p,evaluator:"Cipressus",timestamp:Date.now()}}else e.users[r].scores.asistencia={score:0,evaluator:"Cipressus",timestamp:Date.now()};else e.users[r].scores={asistencia:{score:0,evaluator:"Cipressus",timestamp:Date.now()}};e.user&&e.user.scores&&(e.user.scores.asistencia=e.users[s.user.uid].scores.asistencia),i(),a(e.activities.id),n(),o(),s.loading=!1,s.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,s.$apply()})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,s.$apply()})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,s.$apply()})}]);
app.controller("calendar",["$scope","$rootScope","$location",function(e,t,n){if(!t.userLogged)return void n.path("/login");t.loading=!0,t.sidenav.close(),e.events=[];var d=M.Modal.init(document.getElementById("view_modal"),{}),l=M.Modal.init(document.getElementById("edit_modal"),{}),a=M.Modal.init(document.getElementById("confirm_delete_modal"),{}),s=M.Modal.init(document.getElementById("confirm_move_modal"),{});M.FormSelect.init(document.querySelectorAll("select"),{}),e.refreshCalendar=function(){$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("renderEvents",e.events)},$("#calendar").fullCalendar({weekends:!1,editable:t.user.admin,locale:"es-us",lang:"es",allDaySlot:!1,minTime:"08:00",maxTime:"22:00",timeFormat:"HH:mm",dateFormat:"DD/MM",slotLabelInterval:"01:00",slotLabelFormat:"HH:mm",header:{center:"month,agendaWeek"},eventSources:[{events:e.events}],eventDrop:function(n){e.selectedEvent={author:t.user.uid,attendance:n.attendance||!1,color:n.color,start:1e3*moment(n.start._d).unix()+108e5,end:1e3*moment(n.end._d).unix()+108e5,info:n.info,timestamp:Date.now(),title:n.title},e.selectedEventExtras={id:n.id,idx:n.idx},s.open(),e.$apply()},eventResize:function(n){e.selectedEvent={author:t.user.uid,attendance:n.attendance||!1,color:n.color,start:1e3*moment(n.start._d).unix()+108e5,end:1e3*moment(n.end._d).unix()+108e5,info:n.info,timestamp:Date.now(),title:n.title},e.selectedEventExtras={id:n.id,idx:n.idx},s.open(),e.$apply()},eventClick:function(t){e.selectedEvent={author:t.author,attendance:t.attendance||!1,color:t.color,start:1e3*moment(t.start._d).unix()+108e5,end:1e3*moment(t.end._d).unix()+108e5,info:t.info,timestamp:t.timestamp,title:t.title},e.selectedEventExtras={id:t.id,idx:t.idx,startDay:moment(t.start).format("DD/MM"),startTime:moment(t.start).format("HH:mm"),endTime:moment(t.end).format("HH:mm"),fromNow:moment(t.start).fromNow()},d.open(),e.$apply()},viewRender:function(t,n){e.refreshCalendar()}}),e.confirmDeleteEvent=function(){d.close(),setTimeout(function(){a.open()},650)},e.editEvent=function(t){t?(e.selectedEvent={attendance:!1},e.selectedEventExtras=null,document.getElementById("event_date").value=null,document.getElementById("event_start_time").value=null,document.getElementById("event_end_time").value=null,document.getElementById("tag_select").value="#aaaaaa"):(d.close(),document.getElementById("event_date").value=moment(e.selectedEvent.start).format("YYYY-MM-DD"),document.getElementById("event_start_time").value=moment(e.selectedEvent.start).format("HH:mm"),document.getElementById("event_end_time").value=moment(e.selectedEvent.end).format("HH:mm"),document.getElementById("tag_select").value=e.selectedEvent.color,setTimeout(function(){M.updateTextFields()},200)),setTimeout(function(){l.open()},650)},e.saveEvent=function(){t.loading=!0,e.selectedEvent.author=t.user.uid,e.selectedEvent.timestamp=Date.now(),e.selectedEvent.color=document.getElementById("tag_select").value;var n=document.getElementById("event_date").value,d=document.getElementById("event_start_time").value,a=document.getElementById("event_end_time").value,s=1e3*moment(d+" "+n,"HH:mm YYYY-MM-DD").unix(),o=1e3*moment(a+" "+n,"HH:mm YYYY-MM-DD").unix(),r=0;return e.selectedEvent.title?""==e.selectedEvent.title&&(r=1):r=2,s&&o?o>s?(e.selectedEvent.start=s,e.selectedEvent.end=o):r=3:r=4,"undefined"==e.selectedEvent.info&&(e.selectedEvent.info=""),0!=r?(console.log("Error "+r),console.log("Titulo",e.selectedEvent.title),console.log("Fecha y hora",n,d,a),M.toast({html:"No se ingresó fecha u horarios correctamente",classes:"rounded red",displayLength:2e3}),void(t.loading=!1)):void(e.selectedEventExtras?Cipressus.db.update(e.selectedEvent,"events/"+t.user.course+"/"+e.selectedEventExtras.id).then(function(n){e.selectedEvent.start=moment(e.selectedEvent.start).format(),e.selectedEvent.end=moment(e.selectedEvent.end).format(),e.selectedEvent.id=e.selectedEventExtras.id,e.selectedEvent.idx=e.selectedEventExtras.idx,e.events[e.selectedEventExtras.idx]=e.selectedEvent,e.refreshCalendar(),M.toast({html:"Evento actualizado",classes:"rounded green darken-3",displayLength:2e3}),e.selectedEvent=null,e.selectedEventExtras=null,l.close(),t.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()}):Cipressus.db.push(e.selectedEvent,"events/"+t.user.course).then(function(n){e.selectedEvent.start=moment(e.selectedEvent.start).format(),e.selectedEvent.end=moment(e.selectedEvent.end).format(),e.selectedEvent.idx=e.events.length,e.selectedEvent.id=n.key,e.events.push(e.selectedEvent),$("#calendar").fullCalendar("renderEvent",e.selectedEvent),M.toast({html:"Nuevo evento registrado",classes:"rounded green darken-3",displayLength:2e3}),e.selectedEventExtras=null,l.close(),t.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()}))},e.deleteEvent=function(){t.loading=!0,Cipressus.db.set(null,"events/"+t.user.course+"/"+e.selectedEventExtras.id).then(function(n){e.events.splice(e.selectedEventExtras.idx,1),e.refreshCalendar(),e.selectedEventExtras=null,M.toast({html:"Evento eliminado",classes:"rounded green darken-3",displayLength:2e3}),a.close(),t.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"No se pudo eliminar, intente en otro momento",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})},e.moveEvent=function(){t.loading=!0,Cipressus.db.update(e.selectedEvent,"events/"+t.user.course+"/"+e.selectedEventExtras.id).then(function(n){e.selectedEvent.id=e.selectedEventExtras.id,e.selectedEvent.idx=e.selectedEventExtras.idx,e.selectedEvent.start=moment(e.selectedEvent.start).format(),e.selectedEvent.end=moment(e.selectedEvent.end).format(),e.events[e.selectedEventExtras.idx]=e.selectedEvent,e.refreshCalendar(),e.selectedEventExtras=null,M.toast({html:"Evento actualizado",classes:"rounded green darken-3",displayLength:2e3}),s.close(),t.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})},Cipressus.utils.activityCntr(t.user.uid,"calendar")["catch"](function(e){console.log(e)}),Cipressus.db.get("events/"+t.user.course).then(function(n){var d=0;for(k in n){var l=n[k];l.start=moment(l.start).format(),l.end=moment(l.end).format(),l.id=k,l.idx=d,l.durationEditable=t.user.admin,e.events.push(l),d++}$("#calendar").fullCalendar("renderEvents",e.events),t.loading=!1,e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}]);
app.controller("sources",["$scope","$rootScope","$location",function(e,o,s){if(!o.userLogged)return void s.path("/login");e.pushFiles=function(s){var n=function(n){if(!(document.getElementById("filesInput").files.length>0))return void M.toast({html:"Debe seleccionar los archivos primero",classes:"rounded red",displayLength:1500});var t=[],i=[],r=document.getElementById("filesInput").files;for(var a in r)"object"==typeof r[a]&&(t.push(r[a]),i.push(Cipressus.utils.generateFileName(25)+"."+r[a].name.split(".")[1]));Cipressus.storage.putMultiple(t,"Files",i).then(function(t){e.fileListQueue=[];for(var a in t.urls)e.fileListQueue.push({name:r[a].name.split(".")[0],size:t.sizes[a],format:r[a].name.split(".")[1],link:t.urls[a],filename:i[a],uploaded:Date.now(),downloads:0});Cipressus.db.pushMultiple(e.fileListQueue,"sources/"+n+"/files").then(function(t){var i=0;e.sources?(e.sources[n]||(e.sources[n]={name:s,files:{}}),e.sources[n].files||(e.sources[n].files={})):(e.sources={},e.sources[n]={name:s,files:{}});for(var r in t)e.sources[n].files[t[r].key]=e.fileListQueue[i],i++;M.toast({html:"Direcetorio actualizado.",classes:"rounded green darken-3",displayLength:1500}),o.loading=!1,l.close(),document.getElementById("filesInput").value=null,document.getElementById("filesInputText").value=null,e.$apply()})["catch"](function(s){console.log(s),M.toast({html:"Ocurrio un error guardar archivos.",classes:"rounded red",displayLength:1500}),o.loading=!1,l.close(),e.$apply()})})["catch"](function(s){console.log(s),M.toast({html:"Ocurrio un error al subir archivos",classes:"rounded red",displayLength:1500}),o.loading=!1,e.$apply()})};if(s){o.loading=!0;var t="";for(var i in e.sources)s==e.sources[i].name&&(t=i);""==t?Cipressus.db.push({name:s},"sources").then(function(e){t=e.key,n(t)})["catch"](function(s){console.log(s),M.toast({html:"Error al generar directorio",classes:"rounded red",displayLength:1500}),o.loading=!1,e.$apply()}):n(t)}else M.toast({html:"Debe indicar el nombre del directorio",classes:"rounded red",displayLength:1500})},e.deleteFile=function(o,s){r=[o,s],e.fileToDelete=e.sources[o].files[s]},e.confirmDelete=function(){o.loading=!0,Cipressus.storage["delete"](e.fileToDelete.filename,"Files").then(function(s){Cipressus.db.set(null,"sources/"+r[0]+"/files/"+r[1]).then(function(s){delete e.sources[r[0]].files[r[1]],r=[],M.toast({html:"Archivo eliminado!",classes:"rounded green darken-3",displayLength:1500}),o.loading=!1,n.close(),e.$apply()})["catch"](function(s){console.log(s),M.toast({html:"Ocurrio un error al eliminar archivos",classes:"rounded red",displayLength:1500}),o.loading=!1,e.$apply()})})["catch"](function(s){console.log(s),M.toast({html:"Ocurrio un error al eliminar archivos",classes:"rounded red",displayLength:1500}),o.loading=!1,e.$apply()})},e.openImage=function(e){document.getElementById("image_viewer").src=e,i.open()},e.openPdfViewer=function(o){e.pdfURL=o,t.open()},M.Collapsible.init(document.querySelectorAll(".collapsible"),{});var l=M.Modal.init(document.getElementById("files_modal"),{preventScrolling:!1}),n=M.Modal.init(document.getElementById("confirm_delete_modal"),{preventScrolling:!1}),t=M.Modal.init(document.getElementById("pdf_viewer_modal"),{preventScrolling:!1}),i=M.Modal.init(document.getElementById("image_viewer_modal"),{preventScrolling:!1}),r=[];o.loading=!0,o.sidenav.close(),Cipressus.utils.activityCntr(o.user.uid,"sources")["catch"](function(e){console.log(e)}),Cipressus.db.get("sources").then(function(s){e.sources=s;var l={};for(var n in e.sources)l[e.sources[n].name]=null;M.Autocomplete.init(document.querySelector(".autocomplete"),{data:l}),o.loading=!1,e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}]);
app.controller("submissions",["$scope","$rootScope","$location",function(e,s,t){if(!s.userLogged)return void t.path("/login");e.resetForm=function(){e.selectedActivity=null},e.pushFile=function(){if(e.selectedActivity){var t=document.getElementById("obsTextarea").value;t||(t="");var n={activityId:e.selectedActivity.id,activityName:e.selectedActivity.name,created:Date.now(),authors:[s.user.uid].concat(s.user.partners?s.user.partners:[]),status:[{timestamp:Date.now(),action:0,display:"Archivo subido",user:s.user.uid,obs:t}]};e.selectedSim&&(n.simulation=angular.copy(e.selectedSim));var a=document.getElementById("fileInput").files;if(a.length>0){s.loading=!0;var o=new FileReader,l=0,u=[];o.addEventListener("load",function(t){if(u.push({data:t.target.result,name:a[l].name}),l++,l==a.length)try{var r=new JSZip;for(var c in u)r.file(u[c].name,u[c].data.split(",")[1],{base64:!0});r.generateAsync({type:"blob"}).then(function(t){n.filename=Cipressus.utils.generateFileName(25)+".zip",Cipressus.storage.put(t,"Submissions",n.filename).then(function(t){n.size=t.size,n.link=t.url,Cipressus.db.push(n,"submissions/"+s.user.course).then(function(t){e.submissions[t.key]=n,e.submCnt++,document.getElementById("fileInput").files=null,document.getElementById("fileInputText").value="",M.toast({html:"Entrega realizada correctamente",classes:"rounded green",displayLength:1500}),Cipressus.db.query("users_private","admin",!0).then(function(e){var t={icon:"info",link:"submissions",title:"Nueva entrega",text:"Nueva actividad presentada: "+n.activityName},i=e.val();for(var a in i)i[a].course==s.user.course&&Cipressus.utils.sendNotification(a,t)})["catch"](function(e){console.log(e)}),s.loading=!1,i.close(),e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al subir el archivo",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al subir el archivo",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})})}catch(d){console.log(d),M.toast({html:"Ocurrió un error al comprimir adjuntos.",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()}else o.readAsDataURL(a[l])}),o.readAsDataURL(a[l])}else console.log("Problema con el archivo"),M.toast({html:"Debe seleccionar un archivo!",classes:"rounded red",displayLength:1500})}else console.log("Identificador de actividad desconocido"),M.toast({html:"Debe seleccionar una actividad!",classes:"rounded red",displayLength:1500})},e.downloaded=function(i,n){var a=function(){window.open(n.link),n.simulation&&(s.openSimulation=n.simulation.data,t.path("/simulator"),e.$apply())};if(0==e.submissions[i].status[e.submissions[i].status.length-1].action){var o={timestamp:Date.now(),action:1,display:"Archivo en revisión",user:s.user.uid,obs:""};e.submissions[i].status.push(o);var l=JSON.parse(angular.toJson(e.submissions[i]));Cipressus.db.update(l,"submissions/"+s.user.course+"/"+i).then(function(e){M.toast({html:"Movimiento registrado",classes:"rounded green",displayLength:1e3}),a()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrio un error al registrar movimiento",classes:"rounded red",displayLength:1500})})}else M.toast({html:"El archivo ya está siendo evaluado",classes:"rounded cyan",displayLength:1500}),a()},e.viewSubm=function(s){e.submKeyView=s,o.open()},e.evaluated=function(s){e.evaluatingKey=s;var t=Cipressus.utils.searchNode(e.activityTree,e.submissions[e.evaluatingKey].activityId);e.leafActivities=Cipressus.utils.getLeafNodes(t);for(var i in e.leafActivities)document.getElementById("scoreInput_"+e.leafActivities[i].id).value=0;a.open()},e.confirmEvaluate=function(){var t=parseInt(document.getElementById("evaluation_select").value),i=document.getElementById("obsTextarea2").value,n={};if(3==t)for(var o in e.leafActivities){var l=document.getElementById("scoreInput_"+e.leafActivities[o].id).value;l&&(n[e.leafActivities[o].id]=parseInt(l))}if(""==i&&(i="Sin observaciones"),t)if(3==t&&Object.getOwnPropertyNames(n).length==e.leafActivities.length||3!=t)if(1==e.submissions[e.evaluatingKey].status[e.submissions[e.evaluatingKey].status.length-1].action){s.loading=!0;var u={timestamp:Date.now(),action:t,display:2==t?"Revisar":3==t?"Aprobado":"?",user:s.user.uid,obs:i},r=JSON.parse(angular.toJson(e.submissions[e.evaluatingKey].status));r.push(u);var c=[];c.push(Cipressus.db.update(r,"submissions/"+s.user.course+"/"+e.evaluatingKey+"/status"));for(var o in e.submissions[e.evaluatingKey].authors){if(3==t){for(var d in n){var l={evaluator:s.user.uid,score:n[d],timestamp:Date.now()};c.push(Cipressus.db.update(l,"users_private/"+e.submissions[e.evaluatingKey].authors[o]+"/scores/"+d))}var m={evaluator:s.user.uid,submitted:e.submissions[e.evaluatingKey].created,timestamp:Date.now()};c.push(Cipressus.db.update(m,"users_private/"+e.submissions[e.evaluatingKey].authors[o]+"/submits/"+e.submissions[e.evaluatingKey].activityId))}var p={icon:"info",link:"submissions",title:"Presentación evaluada",text:"La actividad "+e.submissions[e.evaluatingKey].activityName+" que presentaste ya fue calificada."};Cipressus.utils.sendNotification(e.submissions[e.evaluatingKey].authors[o],p)}Promise.all(c).then(function(t){e.submissions[e.evaluatingKey].status.push(u),M.toast({html:"Movimiento registrado",classes:"rounded green",displayLength:1e3}),s.loading=!1,a.close(),document.getElementById("evaluation_select").value="",document.getElementById("obsTextarea2").value="",e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrio un error al registrar movimiento",classes:"rounded red",displayLength:1500})})}else console.log(e.submissions[key].status),M.toast({html:"El archivo ya fue evaluado!",classes:"rounded red",displayLength:1500});else console.log("Evaluadas: "+Object.getOwnPropertyNames(n).length,"Totales: "+e.leafActivities.length),M.toast({html:"Complete las calificaciones!",classes:"rounded red",displayLength:1500});else console.log("Input select con opcion por defecto."),M.toast({html:"Seleccione resultado de evaluación",classes:"rounded red",displayLength:1500})},e.deleteFile=function(s){e.fileKeyToDelete=s},e.confirmDelete=function(){var t=function(){Cipressus.db.set(null,"submissions/"+s.user.course+"/"+e.fileKeyToDelete).then(function(t){delete e.submissions[e.fileKeyToDelete],e.fileKeyToDelete="",s.loading=!1,e.submCnt--,n.close(),e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrio un error al eliminar archivos",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})};s.loading=!0,Cipressus.storage["delete"](e.submissions[e.fileKeyToDelete].filename,"Submissions").then(function(e){t()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al eliminar archivos. Intente más tarde",classes:"rounded red",displayLength:1500}),s.loading=!1,e.$apply()})};var i=M.Modal.init(document.getElementById("files_modal"),{preventScrolling:!1}),n=M.Modal.init(document.getElementById("confirm_delete_modal"),{preventScrolling:!1}),a=M.Modal.init(document.getElementById("confirm_evaluate_modal"),{preventScrolling:!1}),o=M.Modal.init(document.getElementById("submission_modal"),{preventScrolling:!1});M.Modal.init(document.getElementById("tutorial_modal"),{preventScrolling:!1}),e.fileKeyToDelete="",e.selectedActivity=null,s.loading=!0,s.sidenav.close(),Cipressus.utils.activityCntr(s.user.uid,"submissions")["catch"](function(e){console.log(e)}),Cipressus.db.get("submissions/"+s.user.course).then(function(t){if(e.submissions={},e.submCnt=0,s.user.admin&&t)e.submissions=t,e.submCnt=Object.getOwnPropertyNames(e.submissions).length;else for(var i in t)t[i].authors.indexOf(s.user.uid)>-1&&(e.submissions[i]=t[i],e.submCnt++);Cipressus.db.get("users_public").then(function(t){e.users=t,Cipressus.db.get("activities/"+s.user.course).then(function(t){e.activityTree=t,e.activities=Cipressus.utils.getArray(t),s.loading=!1,e.$apply(),M.FormSelect.init(document.querySelectorAll("select"),{}),document.getElementById("activity_select").addEventListener("change",function(){var t=document.getElementById("activity_select"),i=e.activities.findIndex(function(e){return e.id==t.options[t.selectedIndex].value});e.selectedActivity=null;for(var n in e.submissions)if(e.submissions[n].activityId==t.options[t.selectedIndex].value&&e.submissions[n].authors.includes(s.user.uid))return M.toast({html:"Ya realizó la entrega de esta actividad. Elimine la anterior.",classes:"rounded red",displayLength:2e3}),void e.$apply();e.selectedActivity={id:t.options[t.selectedIndex].value,name:t.options[t.selectedIndex].text,deadline:e.activities[i].dl.date,type:e.activities[i].dl.submit},s.loading=!0,e.$apply(),e.simulations=[],Cipressus.db.query("simulations","uid",s.user.uid).then(function(t){t.forEach(function(s){var t=s.val();t.id=s.key,t.index=e.simulations.length,e.simulations.push(t)}),s.loading=!1,e.$apply(),M.FormSelect.init(document.querySelectorAll("select"),{}),document.getElementById("simulation_select").addEventListener("change",function(){var s=document.getElementById("simulation_select"),t=e.simulations.findIndex(function(e){return e.id==s.options[s.selectedIndex].value});t>=0?e.selectedSim=e.simulations[t]:e.selectedSim=null})})["catch"](function(e){console.log(e)})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}]);
app.controller("hardware",["$scope","$rootScope","$location",function(t,u,n){if(!u.userLogged)return void n.path("/login");u.sidenav.close(),Cipressus.utils.activityCntr(u.user.uid,"hardware")["catch"](function(t){console.log(t)});var o=function(){"CONNECTED"==Cipressus.hardware.status&&(t.tester=[{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1}],Cipressus.hardware.io=t.tester,Cipressus.hardware.onUpdate=function(){t.$apply()})},e=function(){t.tester&&(t.tester=null)};o(),u.onWssDisconnect=function(){e()},u.onWssConnect=function(){o()}}]);
app.controller("analizer",["$scope","$rootScope","$location",function(t,n,a){if(!n.userLogged)return void a.path("/login");n.sidenav.close(),Cipressus.utils.activityCntr(n.user.uid,"analizer")["catch"](function(t){console.log(t)}),t.running=!1;var e=Highcharts.chart("chart_container",{chart:{type:"line",animation:!1,height:"50%"},credits:{enabled:!1},title:{text:"Analizador lógico"},yAxis:{title:{text:"Voltaje"}},tooltip:{headerFormat:"<b>{series.name}</b><br/>",pointFormat:"{point.y:.2f}"},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Entrada 1",data:[[Date.now(),0]]},{name:"Entrada 2",data:[[Date.now(),0]]},{name:"Entrada 3",data:[[Date.now(),0]]},{name:"Entrada 4",data:[[Date.now(),0]]},{name:"Entrada 5",data:[[Date.now(),0]]},{name:"Entrada 6",data:[[Date.now(),0]]},{name:"Entrada 7",data:[[Date.now(),0]]},{name:"Entrada 8",data:[[Date.now(),0]]}]}),o=e.series,i=function(){"CONNECTED"==Cipressus.hardware.status&&(t.tester=[{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1},{output:!1,input:!1}],Cipressus.hardware.io=t.tester,Cipressus.hardware.onUpdate=function(){for(var n=Date.now(),a=0;8>a;a++)o[a].addPoint([n,t.tester[a].input?5:0],!1,o[a].data.length>300)})},r=function(){e.redraw(),t.running&&setTimeout(r,100)};t.toggleStartStop=function(){t.running=!t.running,t.running&&r()},n.onWssDisconnect=function(){t.tester&&(t.tester=null)},n.onWssConnect=function(){i()},i()}]);
app.controller("simulator",["$scope","$rootScope","$location",function(e,t,i){if(!t.userLogged)return void i.path("/login");t.sidenav.close(),e.updateFields=function(){setTimeout(function(){M.updateTextFields()},200)},e.getSimulations=function(){e.simulations?s.open():(t.loading=!0,Cipressus.db.query("simulations","uid",t.user.uid).then(function(i){simulations_data={},i.forEach(function(e){simulations_data[e.key]=e.val()}),simulations_data?(e.simulations=simulations_data,s.open()):M.toast({html:"No hay circuitos guardados!",classes:"rounded green darken-3",displayLength:2e3}),t.loading=!1,e.$apply()})["catch"](function(i){console.log(i),M.toast({html:"Ocurrió un error al mostrar archivos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()}))},e.loadCircuit=function(t,i){var o;o=t?JSON.parse(e.simulations[t].data):JSON.parse(i),simcir.clearDevices(),o.showToolbox=!0,o.width=document.getElementById("simcir").clientWidth,o.height=document.getElementById("simcir").clientHeight,o.toolbox=[{type:"In"},{type:"Out"},{type:"Joint"},{type:"DC"},{type:"LED"},{type:"PushOff"},{type:"PushOn"},{type:"Toggle"},{type:"BUF"},{type:"NOT"},{type:"AND"},{type:"NAND"},{type:"OR"},{type:"NOR"},{type:"XOR"},{type:"XNOR"},{type:"OSC"},{type:"7seg"},{type:"16seg"},{type:"4bit7seg"},{type:"RotaryEncoder"},{type:"BusIn"},{type:"BusOut"},{type:"RS-FF"},{type:"JK-FF"},{type:"T-FF"},{type:"D-FF"},{type:"8bitCounter"},{type:"HalfAdder"},{type:"FullAdder"},{type:"4bitAdder"},{type:"2to4BinaryDecoder"},{type:"3to8BinaryDecoder"},{type:"4to16BinaryDecoder"},{type:"Test-In"},{type:"Test-Out"},{type:"Audio-Out"},{type:"DSO"},{type:"Transmitter"}],simcir.setupSimcir($("#simcir"),o),t&&(n={key:t,name:e.simulations[t].name},e.circuitFileName=e.simulations[t].name,s.close())},e.saveCircuit=function(){if(t.loading=!0,n={},e.simulations)for(var i in e.simulations)e.simulations[i].name==e.circuitFileName&&(n={key:i,name:e.simulations[i].name});var s=simcir.controller($("#simcir").find(".simcir-workspace")).data(),a=JSON.stringify(function(e){return{devices:e.devices,connectors:e.connectors}}(s));if(0==s.devices.length)M.toast({html:"No hay componentes!",classes:"rounded red",displayLength:2e3}),t.loading=!1;else{var r={timestamp:Date.now(),size:s.devices.length,data:a,name:e.circuitFileName};n.key?Cipressus.db.update(r,"simulations/"+n.key).then(function(i){e.simulations[n.key]=r,o.close(),t.loading=!1,e.$apply()})["catch"](function(i){console.log(i),M.toast({html:"Ocurrió un error al guardar",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()}):(r.uid=t.user.uid,Cipressus.db.push(r,"simulations").then(function(i){n={key:i.key,name:r.name},e.simulations||(e.simulations={}),e.simulations[i.key]=r,o.close(),t.loading=!1,e.$apply()})["catch"](function(i){console.log(i),M.toast({html:"Ocurrió un error al guardar",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()}))}},e.analizeCircuit=function(){var i=simcir.getExternalLabels("input"),n=simcir.getExternalLabels("output");if(0==i.length)return void M.toast({html:"El circuito no tiene entradas de testeo!",classes:"rounded red",displayLength:2e3});if(0==n.length)return void M.toast({html:"El circuito no tiene salidas de testeo!",classes:"rounded red",displayLength:2e3});t.loading=!0;var s=i.length+n.length;i=i.filter(function(e,t,i){return i.indexOf(e)===t});var o=simcir.controller($("#simcir").find(".simcir-workspace")).data();e.circuitDetails={model:o,deviceCnt:o.devices.length-s,connectorCnt:o.connectors.length,truthTable:{header:{inputs:i,outputs:n},rows:[]},expressions:[],canonMinTerm:[],canonMaxTerm:[]};var a=Math.pow(2,i.length),l=[],c=[],u=[],d=[],p=[],m=[],y=function(){for(var s in n)if(l[s])if(c[s]){for(var o in l[s]){for(var a in l[s][o])switch(l[s][o][a]){case"1":p[s]?p[s]+=i[a]:p[s]=i[a];break;case"0":p[s]?p[s]+=i[a]+"'":p[s]=i[a]+"'"}p[s]+=" + "}p[s]=p[s].substring(0,p[s].length-3);for(var o in c[s]){m[s]?m[s]+="(":m[s]="(";for(var a in c[s][o])switch(c[s][o][a]){case"0":m[s]+=i[a]+"+";break;case"1":m[s]+=i[a]+"'+"}m[s]=m[s].substring(0,m[s].length-1),m[s]+=") · "}m[s]=m[s].substring(0,m[s].length-3)}else p[s]="1",m[s]="1";else p[s]="0",m[s]="0";for(var s in p)e.circuitDetails.canonMinTerm[s]="<b>"+n[s]+"</b>= "+p[s];for(var s in m)e.circuitDetails.canonMaxTerm[s]="<b>"+n[s]+"</b>= "+m[s];t.loading=!1,r.open(),e.$apply()},g=function(){for(var t in n)if(l[t])if(l[t].length!=a){u[t]=Cipressus.utils.getPrimeImplicants(l[t]);for(var s in u[t]){for(var o in u[t][s])switch(u[t][s][o]){case"1":d[t]?d[t]+=i[o]:d[t]=i[o];break;case"0":d[t]?d[t]+=i[o]+"'":d[t]=i[o]+"'";break;case"-":}d[t]+=" + "}d[t]=d[t].substring(0,d[t].length-3)}else d[t]="1";else d[t]="0";for(var t in d)e.circuitDetails.expressions[t]="<b>"+n[t]+"</b>= "+d[t];y()},h=function(t){var s=t.toString(2).padStart(i.length,"0");e.circuitDetails.truthTable.rows[t]={inputs:s.split(""),outputs:[]};for(var o in e.circuitDetails.truthTable.rows[t].inputs)simcir.setInputStatus(i[o],"1"==e.circuitDetails.truthTable.rows[t].inputs[o]);setTimeout(function(){for(var i in n)e.circuitDetails.truthTable.rows[t].outputs[i]=1==simcir.getOutputStatus(n[i])?"1":"0","1"==e.circuitDetails.truthTable.rows[t].outputs[i]?l[i]?l[i].push(s):l[i]=[s]:c[i]?c[i].push(s):c[i]=[s];t++,a>t?h(t):g()},50)};h(0)},e.selectToDelete=function(t){e.selected=e.simulations[t],e.selected.key=t,s.close(),setTimeout(function(){a.open()},500)},e.deleteCircuit=function(){t.loading=!0,Cipressus.db.set(null,"simulations/"+e.selected.key).then(function(){delete e.simulations[e.selected.key],e.selected=null,a.close(),t.loading=!1,e.$apply()})["catch"](function(i){console.log(i),t.loading=!1,e.$apply()})},e.circuitFileName="";var n={};M.Modal.init(document.getElementById("tutorial_modal"),{});var s=M.Modal.init(document.getElementById("load_modal"),{preventScrolling:!1}),o=M.Modal.init(document.getElementById("save_modal"),{preventScrolling:!1}),a=M.Modal.init(document.getElementById("delete_modal"),{preventScrolling:!1}),r=M.Modal.init(document.getElementById("results_modal"),{preventScrolling:!1});if(t.openSimulation){var l=t.openSimulation;t.openSimulation=null,e.loadCircuit(null,l)}else simcir.setupSimcir($("#simcir"),{width:document.getElementById("simcir").clientWidth,height:document.getElementById("simcir").clientHeight});window.onresize=function(e){var t=document.getElementById("simcir");if(t){var i=t.clientWidth,n=t.clientHeight,s=document.getElementsByClassName("simcir-workspace")[0];s.setAttribute("viewBox","0 0 "+i+" "+n),s.setAttribute("width",i),s.setAttribute("height",n)}},Cipressus.utils.activityCntr(t.user.uid,"simulator")["catch"](function(e){console.log(e)})}]);
app.controller("kMaps",["$scope","$rootScope","$location",function(a,n,e){return n.userLogged?(n.sidenav.close(),M.Modal.init(document.getElementById("tutorial_modal"),{}),qmc=new QuineMcCluskey("",2,4,0),qmc.init(),karnaugh=new KarnaughMap("myKarnaughMap",qmc),karnaugh.init(),a.varsNum=4,a.showDCares=!1,setTimeout(function(){M.updateTextFields()},200),a.varNumChange=function(){karnaugh.setNoOfVars(a.varsNum)},a.dCareChange=function(){karnaugh.allowDontCares(a.showDCares)},void Cipressus.utils.activityCntr(n.user.uid,"kMaps")["catch"](function(a){console.log(a)})):void e.path("/login")}]);
app.controller("tables",["$scope","$rootScope","$location",function(o,t,e){return t.userLogged?(t.sidenav.close(),M.Modal.init(document.getElementById("tutorial_modal"),{}),o.varsNum=4,o.showDCares=!1,setTimeout(function(){M.updateTextFields()},200),o.varNumChange=function(){},o.dCareChange=function(){},void Cipressus.utils.activityCntr(t.user.uid,"tables")["catch"](function(o){console.log(o)})):void e.path("/login")}]);
app.controller("videos",["$scope","$rootScope","$location",function(e,d,o){if(!d.userLogged)return void o.path("/login");d.sidenav.close(),e.selectVideo=function(d){d?(e.selectedVideoKey=d,e.selectedVideo={title:e.videos[d].title,source:e.videos[d].source,link:"youtube"==e.videos[d].source?"https://www.youtube.com/watch?v="+e.videos[d].link:"https://drive.google.com/file/d/"+e.videos[d].link+"/view?usp=sharing",uploaded:e.videos[d].uploaded},setTimeout(function(){M.updateTextFields()},250)):(e.selectedVideoKey=null,e.selectedVideo={title:"",source:"",link:"",uploaded:0})},e.saveVideo=function(){if(""==e.selectedVideo.title)return void M.toast({html:"Debe indicar un nombre",classes:"rounded red",displayLength:1500});if(d.loading=!0,e.selectedVideo.source=document.getElementById("video_source").value,"youtube"==e.selectedVideo.source){if(!e.selectedVideo.link.includes("?v="))return M.toast({html:"Ingrese un enlace válido!",classes:"rounded red",displayLength:1500}),void(d.loading=!1);e.selectedVideo.link=e.selectedVideo.link.split("?v=")[1]}else{if(!e.selectedVideo.link.includes("/d/"))return M.toast({html:"Ingrese un enlace válido!",classes:"rounded red",displayLength:1500}),void(d.loading=!1);e.selectedVideo.link=e.selectedVideo.link.split("/d/")[1],e.selectedVideo.link=e.selectedVideo.link.substring(0,e.selectedVideo.link.indexOf("/"))}e.selectedVideoKey?Cipressus.db.update(e.selectedVideo,"videos/"+d.user.course+"/"+e.selectedVideoKey).then(function(o){e.videos[e.selectedVideoKey]={title:e.selectedVideo.title,link:e.selectedVideo.link,source:e.selectedVideo.source,uploaded:e.selectedVideo.uploaded},delete e.selectedVideo,delete e.selectedVideoKey,M.toast({html:"Datos actualizados!",classes:"rounded green darken-3",displayLength:1500}),l.close(),d.loading=!1,e.$apply()})["catch"](function(o){console.log(o),M.toast({html:"Ocurrió un error al actualizar cambios.",classes:"rounded red",displayLength:1500}),d.loading=!1,e.$apply()}):(e.selectedVideo.uploaded=Date.now(),Cipressus.db.push(e.selectedVideo,"videos/"+d.user.course).then(function(o){e.videos||(e.videos={}),e.videos[o.key]={title:e.selectedVideo.title,link:e.selectedVideo.link,source:e.selectedVideo.source,uploaded:e.selectedVideo.uploaded},delete e.selectedVideo,delete e.selectedVideoKey,M.toast({html:"Nuevo video creado!",classes:"rounded green darken-3",displayLength:1500}),l.close(),d.loading=!1,e.$apply()})["catch"](function(o){console.log(o),M.toast({html:"Ocurrio un error al actualizar cambios.",classes:"rounded red",displayLength:1500}),d.loading=!1,e.$apply()}))},e.confirmDelete=function(){d.loading=!0,Cipressus.db.set(null,"videos/"+d.user.course+"/"+e.selectedVideoKey).then(function(o){delete e.videos[e.selectedVideoKey],delete e.selectedVideo,delete e.selectedVideoKey,M.toast({html:"Video eliminado!",classes:"rounded green darken-3",displayLength:1500}),d.loading=!1,i.close(),e.$apply()})["catch"](function(o){console.log(o),M.toast({html:"Ocurrio un error al eliminar el video",classes:"rounded red",displayLength:1500}),d.loading=!1,e.$apply()})};var l=M.Modal.init(document.getElementById("video_edit_modal"),{}),i=M.Modal.init(document.getElementById("confirm_delete_modal"),{});M.FormSelect.init(document.querySelectorAll("select"),{}),Cipressus.utils.activityCntr(d.user.uid,"videos")["catch"](function(e){console.log(e)}),d.loading=!0,Cipressus.db.get("videos/"+d.user.course).then(function(o){e.videos=o,d.loading=!1,e.$apply()})["catch"](function(o){console.log(o),d.loading=!1,e.$apply()})}]);
app.controller("users",["$scope","$rootScope","$location",function(e,s,t){if(!s.userLogged)return void t.path("/login");s.loading=!0,s.sidenav.close(),e.selectedKey=null,e.selectedIndex=null,e.showAll=!0;var i=0;e.orderTag="name",e.reverseOrder=!1,e.changeOrder=function(s){e.orderTag===s?e.reverseOrder=!e.reverseOrder:(e.orderTag=s,e.reverseOrder=!1)};var r=function(){e.auxiliarySubmits[this.id]={submitted:1e3*moment(this.value).unix(),timestamp:Date.now(),evaluator:s.user.uid},e.$apply()};e.viewUser=function(s){e.selectedKey=s,e.selectedIndex=e.getUserIndex[s],a(),n()},e.selectUser=function(s){e.selectedKey=s,e.selectedIndex=e.getUserIndex[s],o.open()};var a=function(){if(e.users[e.selectedIndex].scores)if(e.users[e.selectedIndex].attendance){var s=Object.getOwnPropertyNames(e.users[e.selectedIndex].attendance).length,t=i>0?s/i*100:0;e.users[e.selectedIndex].scores.asistencia={score:parseInt(t.toFixed(2)),evaluator:"Cipressus",timestamp:Date.now()}}else e.users[e.selectedIndex].scores.asistencia={score:0,evaluator:"Cipressus",timestamp:Date.now()}},n=function(){var s=[];e.currentNode=Cipressus.utils.searchNode(e.activitiesTree,"final");var t=Cipressus.utils.eval(e.users[e.selectedIndex],e.currentNode),i=t.score/e.currentNode.score*100;e.currentActivityScores={name:e.currentNode.name,points:(e.currentNode.score*i/100).toFixed(2),score:i.toFixed(2),children:[]};for(k in e.currentNode.children){var r=Cipressus.utils.eval(e.users[e.selectedIndex],e.currentNode.children[k]),a=r.score/e.currentNode.children[k].score*100;e.currentActivityScores.children.push({name:e.currentNode.children[k].name,points:(e.currentNode.children[k].score*a/100).toFixed(2),score:a.toFixed(2)}),s.push({y:e.currentNode.children[k].score,z:parseInt(a.toFixed(2)),name:e.currentNode.children[k].name})}Highcharts.chart("variable_pie_container",{chart:{type:"variablepie",height:"100%"},title:{text:"Calificaciones"},tooltip:{headerFormat:"",pointFormat:'<span style="color:{point.color}">●</span> <b> {point.name}</b><br/>Nota actividad: <b>{point.z}%</b><br/>'},series:[{minPointSize:10,innerSize:"20%",zMin:0,name:"Notas",data:s}]})};e.enrollUser=function(){var t={admin:!1,course:s.user.course,enrolled:Date.now()};e.selectedKey&&(s.loading=!0,Cipressus.db.update(t,"users_private/"+e.selectedKey).then(function(i){e.users[e.selectedIndex].admin=!1,e.users[e.selectedIndex].enrolled=t.enrolled,M.toast({html:"Listo!",classes:"rounded green darken-3",displayLength:2e3}),o.close();var r={icon:"info",link:"home",title:"Inscripción aceptada",text:"Has sido incorporado al curso: "+e.activitiesTree.course.name};Cipressus.utils.sendNotification(e.selectedKey,r),e.selectedKey=null,e.selectedIndex=null,s.loading=!1,e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()}))},e.evalUser=function(s){e.selectedKey=s,e.selectedIndex=e.getUserIndex[s],a(),e.auxiliaryScores={};for(var t in e.users[e.selectedIndex].scores)e.auxiliaryScores[t]={evaluator:e.users[e.selectedIndex].scores[t].evaluator,score:e.users[e.selectedIndex].scores[t].score,timestamp:e.users[e.selectedIndex].scores[t].timestamp};e.auxiliarySubmits={};for(var t in e.users[e.selectedIndex].submits)e.auxiliarySubmits[t]={evaluator:e.users[e.selectedIndex].submits[t].evaluator,submitted:e.users[e.selectedIndex].submits[t].submitted,timestamp:e.users[e.selectedIndex].submits[t].timestamp};for(var t in e.activities)e.activities[t].dl&&(e.auxiliarySubmits[e.activities[t].id]?document.getElementById(e.activities[t].id).value=moment(e.auxiliarySubmits[e.activities[t].id].submitted).format("YYYY-MM-DD"):document.getElementById(e.activities[t].id).value="",document.getElementById(e.activities[t].id).removeEventListener("change",r),document.getElementById(e.activities[t].id).addEventListener("change",r));c.open()},e.getCost=function(s){if(e.activities[s]&&e.auxiliarySubmits&&e.auxiliarySubmits[e.activities[s].id]){if(e.auxiliarySubmits[e.activities[s].id].submitted>e.activities[s].dl.date){var t=Cipressus.utils.defaultCostFunction(e.auxiliarySubmits[e.activities[s].id].submitted,e.activities[s].dl.date,e.activities[s].dl.param);return t>e.activities[s].score?e.activities[s].score:t.toFixed(2)}return 0}},e.deleteSubmit=function(s){document.getElementById(s).removeEventListener("change",r),document.getElementById(s).value="",e.auxiliarySubmits[s]=null,document.getElementById(s).addEventListener("change",r)},e.exportExcel=function(){var t=[],i=["UID","Nombre y apellido","Email","Carrera","LU","Comp com."," "];for(var r in e.activities)i.push(e.activities[r].name+" ("+(e.activities[r].score||e.activities[r].value)+")");t.push(i);for(var a in e.users)if(e.users[a].course==s.user.course&&!e.users[a].admin){var n=[e.users[a].key,e.users[a].secondName+", "+e.users[a].name,e.users[a].email,e.users[a].degree,e.users[a].lu,e.users[a].partners?e.users[a].partners.map(function(s){return e.users[e.getUserIndex[s]].secondName}):""," "];for(var r in e.activities){var o=Cipressus.utils.searchNode(e.activitiesTree,e.activities[r].id),c=Cipressus.utils.eval(e.users[a],o);n.push(c.score.toFixed(2)+" ("+(c.score/(e.activities[r].score||e.activities[r].value)*100).toFixed(2)+"%)")}t.push(n)}var d=XLSX.utils.aoa_to_sheet(t),l=XLSX.utils.book_new();XLSX.utils.book_append_sheet(l,d,"Usuarios");var u={bookType:"xlsx",bookSST:!1,type:"array"},m=XLSX.write(l,u);saveAs(new Blob([m],{type:"application/octet-stream"}),"UsuariosCipressus_"+moment().format("DD_MM_YYYY")+".xlsx")},e.saveScores=function(){s.loading=!0;var t={};t.scores=e.auxiliaryScores,t.submits=e.auxiliarySubmits,Cipressus.db.update(t,"users_private/"+e.selectedKey).then(function(t){var i={icon:"info",link:"dashboard",title:"Cambios en calificaciones",text:"Tus calificaciones fueron actualizadas"};Cipressus.utils.sendNotification(e.selectedKey,i),e.users[e.selectedIndex].scores=e.auxiliaryScores,e.users[e.selectedIndex].submits=e.auxiliarySubmits,c.close(),e.selectedIndex=null,e.auxiliaryScores=null,e.auxiliarySubmits=null,M.toast({html:"Calificaciones actualizadas",classes:"rounded green darken-3",displayLength:2e3}),s.loading=!1,e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"No se pudo guardar",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()})},M.Modal.init(document.getElementById("view_modal"),{preventScrolling:!1});var o=(M.Modal.init(document.getElementById("message_modal"),{preventScrolling:!1}),M.Modal.init(document.getElementById("confirm_enroll_modal"),{preventScrolling:!1})),c=M.Modal.init(document.getElementById("scores_modal"),{preventScrolling:!1,dismissible:!1});Cipressus.utils.activityCntr(s.user.uid,"users")["catch"](function(e){console.log(e)}),e.users=[],Cipressus.db.get("users_public").then(function(t){e.getUserIndex={};for(var r in t)e.users.push(t[r]),e.users[e.users.length-1].key=r,e.getUserIndex[r]=e.users.length-1;Cipressus.db.get("users_private").then(function(t){for(var r in t)for(var a in t[r])e.users[e.getUserIndex[r]][a]=t[r][a];Cipressus.db.get("activities/"+s.user.course).then(function(t){e.activitiesTree=t,e.activities=Cipressus.utils.getArray(t),Cipressus.db.getSorted("events/"+s.user.course,"start").then(function(e){e.forEach(function(e){var s=e.val();s.start<=Date.now()&&s.attendance&&i++}),s.loading=!1,s.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,s.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()})})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()})}]);
app.controller("stats",["$scope","$rootScope","$location",function(e,t,s){if(!t.userLogged)return void s.path("/login");t.loading=!0,t.sidenav.close();var r={},a=function(){var t=[],s=[];for(var a in e.users)if(!e.users[a].admin&&e.users[a].scores&&!e.users[a].excludeStat){var i=Cipressus.utils.eval(e.users[a],e.activities).score/e.activities.score*100,o=0;e.users[a].scores&&e.users[a].scores.asistencia&&(o=e.users[a].scores.asistencia.score),r[a]={score:i,activity:0,attendance:o},t.push({name:e.users[a].secondName,y:i,drilldown:a});var n=[];for(var c in e.activities.children)n.push([e.activities.children[c].id,Cipressus.utils.eval(e.users[a],e.activities.children[c]).score/e.activities.children[c].score*100]);s.push({name:e.users[a].secondName,id:a,data:n})}t.sort(function(e,t){return e.y<t.y?1:t.y<e.y?-1:0}),Highcharts.setOptions({lang:{drillUpText:"<< Volver a {series.name}"}}),Highcharts.chart("score_barplot_container",{chart:{type:"bar",height:"75%"},title:{text:"Calificaciones del curso"},xAxis:{type:"category"},yAxis:{title:{text:"Puntaje acumulado"}},credits:{enabled:!1},legend:{enabled:!1},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y:.1f}%"}}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:'<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b>'},series:[{name:"Alumno",colorByPoint:!0,data:t}],drilldown:{colorByPoint:!0,series:s}})};e.drillUp=function(){$("#score_barplot_container").highcharts().drillUp()};var i=function(){var s=[],r=[],a=!0;for(var i in e.users)if(e.users[i].attendance&&!e.users[i].excludeStat){var o=[],n=0,c=0;for(var l in e.events)e.events[l].start<Date.now()&&e.events[l].attendance&&(n++,e.users[i].attendance[l]&&c++,0!=c?o.push(Math.round(c/n*1e4)/100):o.push(0),a&&r.push(t.getTime(3,e.events[l].start)));a=!1,s.push({data:o,name:e.users[i].secondName})}Highcharts.chart("attendance_container",{chart:{type:"spline",height:"70%"},credits:{enabled:!1},title:{text:"Asistencia a clases"},xAxis:{categories:r},series:s})},o=function(){var t=0,s=0,r={Firefox:0,Chrome:0,IE:0,Opera:0,Safari:0,Otro:0},a={Windows:0,Linux:0,IOS:0,Android:0,Otro:0};for(var i in e.users)if(!e.users[i].admin&&!e.users[i].excludeStat){for(var o in e.users[i].activity.browser)r[o]+=e.users[i].activity.browser[o],t+=e.users[i].activity.browser[o];for(var o in e.users[i].activity.os)a[o]+=e.users[i].activity.os[o],s+=e.users[i].activity.os[o]}Highcharts.chart("browser_pie_container",{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},title:{text:"Uso de navegadores"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},credits:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"},connectorColor:"silver"}}},series:[{name:"Uso",data:[{name:"Chrome",y:r.Chrome/t},{name:"Firefox",y:r.Firefox/t},{name:"IE",y:r.IE/t},{name:"Opera",y:r.Opera/t},{name:"Safari",y:r.Safari/t},{name:"Otro",y:r.Otro/t}]}]}),Highcharts.chart("so_pie_container",{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},title:{text:"Uso de S.O."},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},credits:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"},connectorColor:"silver"}}},series:[{name:"Uso",data:[{name:"Windows",y:a.Windows/s},{name:"Linux",y:a.Linux/s},{name:"IOS",y:a.IOS/s},{name:"Android",y:a.Android/s},{name:"Otro",y:a.Otro/s}]}]})},n=function(){var t={home:"Inicio",dashboard:"Dashboard",calendar:"Cronograma",sources:"Material",submissions:"Entregas",simulator:"Simulador",hardware:"Probador",profile:"Perfil"},s=[],a=[],i=!0;for(var o in t){var n=[];for(var c in e.users)e.users[c].admin||e.users[c].excludeStat||(i&&s.push(e.users[c].secondName),e.users[c].activity.items[o]?n.push(e.users[c].activity.items[o]):n.push(0),"home"==o&&e.users[c].scores&&(r[c].activity=e.users[c].activity.items.home));a.push({name:t[o],data:n}),i=!1}Highcharts.chart("items_barplot_container",{chart:{type:"bar",height:"150%"},title:{text:"Uso de herramientas"},xAxis:{categories:s,title:{text:null}},yAxis:{min:0,title:{text:"Accesos",align:"high"},labels:{overflow:"justify"}},tooltip:{valueSuffix:" accesos"},plotOptions:{bar:{dataLabels:{enabled:!0}}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-40,y:80,floating:!0,borderWidth:1,backgroundColor:Highcharts.defaultOptions.legend.backgroundColor||"#FFFFFF",shadow:!0},credits:{enabled:!1},series:a})},c=function(){var e=[],t=[];for(var s in r)e.push([r[s].score,r[s].activity]),t.push([r[s].score,r[s].attendance]);Highcharts.chart("scatterplot_container1",{chart:{type:"scatter",zoomType:"xy"},title:{text:"Calificación vs actividad"},xAxis:{title:{enabled:!0,text:"Calificación"},startOnTick:!0,endOnTick:!0,showLastLabel:!0},yAxis:{title:{text:"Accesos"}},credits:{enabled:!1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}},tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"{point.x} %, {point.y} accesos"}}},series:[{name:"Alumnos",color:"rgba(223, 83, 83, .5)",data:e}]}),Highcharts.chart("scatterplot_container2",{chart:{type:"scatter",zoomType:"xy"},title:{text:"Calificación vs asistencia"},xAxis:{title:{enabled:!0,text:"Calificación"},startOnTick:!0,endOnTick:!0,showLastLabel:!0},yAxis:{title:{text:"Asistencia"}},credits:{enabled:!1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}},tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"{point.x} %, {point.y} %"}}},series:[{name:"Alumnos",color:"rgba(83, 83, 223, .5)",data:t}]})},l=function(){var t=[0,0,0,0],s=0;for(var r in e.users)if(e.users[r].test_fs&&!e.users[r].excludeStat&&e.users[r].test_fs.answers){var a=Cipressus.test_FS.eval(e.users[r].test_fs.answers);s++;for(var i=0;4>i;i++)t[i]+=a[i]}for(var i=0;4>i;i++)t[i]=Math.round(t[i]/s*100)/100;var o=[0,0,0,0];s=0;for(var r in e.users)if(e.users[r].test_fs&&!e.users[r].excludeStat&&e.users[r].test_fs.answers){var a=Cipressus.test_FS.eval(e.users[r].test_fs.answers);s++;for(var i=0;4>i;i++)o[i]+=(a[i]-t[i])*(a[i]-t[i])}for(var i=0;4>i;i++)o[i]=Math.round(100*Math.sqrt(o[i]/s))/100;for(var r=0;4>r;r++){var n=document.getElementById("scale_"+r),c=2*Math.abs(t[r])*50/11;n.style.width=c+"%",t[r]<0?(n.style.marginLeft=50-c+"%",document.getElementById("prof_"+r).innerHTML=Cipressus.test_FS.profileDesc[r][0]):(n.style.marginLeft="50%",document.getElementById("prof_"+r).innerHTML=Cipressus.test_FS.profileDesc[r][1]),n.innerHTML=Math.abs(t[r])+" &#177;"+o[r]}};Cipressus.utils.activityCntr(t.user.uid,"stats")["catch"](function(e){console.log(e)}),Cipressus.db.get("users_public").then(function(s){e.users={},Cipressus.db.query("users_private","course",t.user.course).then(function(r){var d=r.val();for(var u in d){e.users[u]=s[u];for(var p in d[u])e.users[u][p]=d[u][p]}Cipressus.db.get("activities/"+t.user.course).then(function(s){e.activities=s,Cipressus.db.get("events/"+t.user.course).then(function(s){e.events=s,a(),i(),o(),n(),c(),l(),t.loading=!1,e.$apply()})["catch"](function(s){console.log(s),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})})["catch"](function(s){console.log(s),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})})["catch"](function(s){console.log(s),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})})["catch"](function(s){console.log(s),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),t.loading=!1,e.$apply()})}]);
app.controller("attendance",["$scope","$rootScope","$location",function(e,s,t){if(!s.userLogged)return void t.path("/login");s.loading=!0,s.sidenav.close(),e.updateLists=function(){if(e.changes)return void n.open();e.absents=[],e.presents=[];for(var s in e.users)e.users[s].admin||(e.users[s].attendance&&e.users[s].attendance[e.selectedEventKey]?e.presents.push(s):e.absents.push(s));e.$apply()},e.isPresent=function(s){e.changes=!0,e.presents.push(e.absents[s]),e.absents.splice(s,1)},e.isAbsent=function(s){e.changes=!0,e.absents.push(e.presents[s]),e.presents.splice(s,1)},e.saveList=function(){var t={};for(var a in e.presents){var r={evaluator:s.user.uid,timestamp:Date.now()};t["users_private/"+e.presents[a]+"/attendance/"+e.selectedEventKey]=r,e.users[e.presents[a]].attendance||(e.users[e.presents[a]].attendance={}),e.users[e.presents[a]].attendance[e.selectedEventKey]=r}for(var a in e.absents)t["users_private/"+e.absents[a]+"/attendance/"+e.selectedEventKey]=null,e.users[e.absents[a]].attendance||(e.users[e.absents[a]].attendance={}),e.users[e.absents[a]].attendance[e.selectedEventKey]=null;Cipressus.db.update(t).then(function(t){M.toast({html:"Cambios guardados!",classes:"rounded green darken-3 darken-3",displayLength:1500}),s.loading=!1,e.changes=!1,e.$apply(),n.close()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al actualizar cambios",classes:"rounded red",displayLength:2e3})})},Cipressus.utils.activityCntr(s.user.uid,"attendance")["catch"](function(e){console.log(e)});var n=M.Modal.init(document.getElementById("confirm_modal"),{preventScrolling:!1});document.getElementById("event_select").addEventListener("change",function(){e.selectedEventKey=this.value,e.updateLists()}),Cipressus.db.getSorted("events/"+s.user.course,"start").then(function(t){e.events={};var n=Date.now(),a="";t.forEach(function(s){key=s.ref_.path.pieces_[2],e.events[key]=s.val(),e.events[key].start<n&&(a=key)}),e.$apply(),document.getElementById("event_select").value=a,e.selectedEventKey=a,M.FormSelect.init(document.querySelectorAll("select"),{}),Cipressus.db.get("users_private").then(function(t){e.users={};for(var n in t)t[n].course==s.user.course&&(e.users[n]=t[n]);Cipressus.db.get("users_public").then(function(t){for(var n in t)e.users[n]&&(e.users[n].data=t[n]);e.updateLists(),s.loading=!1,e.changes=!1,e.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}]);
app.controller("activities",["$scope","$rootScope","$location",function(e,t,i){if(!t.userLogged)return void i.path("/login");t.sidenav.close();var s=function(t){var i=Cipressus.utils.getArray(t);Highcharts.chart("sunburst_container",{chart:{height:"90%"},title:{text:"Proporción de calificaciones"},subtitle:{text:e.activities.course.name},credits:{enabled:!1},plotOptions:{series:{events:{click:function(t){var i=Cipressus.utils.searchNode(e.activities,t.point.node.id);i&&e.selectActivity(i,!1,!0)}}}},series:[{type:"sunburst",id:"Activities",data:i,allowDrillToNode:!0,cursor:"pointer",dataLabels:{format:"{point.name}",filter:{property:"innerArcLength",operator:">",value:16}},levels:[{level:1,levelIsConstant:!1,dataLabels:{filter:{property:"outerArcLength",operator:">",value:64}}},{level:2,colorIndex:1},{level:3,colorByPoint:!0},{level:4,colorVariation:{key:"brightness",to:-.5}},{level:5,colorVariation:{key:"brightness",to:.5}}]}],tooltip:{headerFormat:"",pointFormat:"La actividad <b>{point.name}</b> suma <b>{point.value}</b> puntos"}})},o=null,a=function(){null!==o&&(o.destroy(),o=null);var t=Cipressus.utils.getTree(e.activities),i=document.getElementById("tree_container"),s={layout:{hierarchical:{direction:"UD"}}};o=new vis.Network(i,t,s),o.on("select",function(t){var i=Cipressus.utils.searchNode(e.activities,t.nodes[0]);i&&e.selectActivity(i,!0,!0)})};e.selectActivity=function(t,i,o){t&&(e.selectedHistory?e.selectedHistory.push(e.selectedNode):e.selectedHistory=[e.selectedNode],e.selectedNode=t,i&&s(t),o&&e.$apply(),M.updateTextFields())},e.selectPreviousActivity=function(){if(e.selectedHistory){var t=e.selectedHistory.pop();t&&(e.selectedNode=t,s(t),M.updateTextFields())}};var r=i.$$search.id;Cipressus.utils.activityCntr(t.user.uid,"activities",r)["catch"](function(e){console.log(e)}),t.loading=!0,r?Cipressus.db.get("activities/"+r).then(function(i){e.activities=i,s(e.activities),a(),e.selectedNode=angular.copy(e.activities),e.selectedHistory=[e.selectedNode],M.updateTextFields(),t.loading=!1,t.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})}):(e.activities={childres:[],course:{start:Date.now(),end:Date.now()+9504e6,name:"Nuevo curso"},id:"final",name:"Nota final",score:100},e.selectedNode=angular.copy(e.activities),s(e.activities),a(),t.loading=!1)}]);
app.controller("courses",["$scope","$rootScope","$location",function(e,o){if(!o.userLogged)return void $location.path("/login");o.sidenav.close();var s=M.Modal.init(document.getElementById("confirm_delete_modal"),{preventScrolling:!1});Cipressus.utils.activityCntr(o.user.uid,"courses")["catch"](function(e){console.log(e)}),e.deleteCourse=function(o){o?(e.selectedCourseKey=o,e.selectedCourseIndex=e.courses.findIndex(function(e){return e.key==o}),s.open()):e.selectedCourseKey||M.toast({html:"La clave de curso no es válida.",classes:"rounded red",displayLength:2e3})},Cipressus.db.get("metadata/courses").then(function(s){e.courses=[];for(var t in s)s[t].key=t,e.courses.push(s[t]);o.loading=!1,o.$apply(),M.FormSelect.init(document.querySelectorAll("select"),{})})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}]);
app.controller("editor",["$scope","$rootScope","$location","localStorageService",function(e,s,n,r){if(!s.userLogged)return void n.path("/login");s.loading=!0,s.sidenav.close(),e.select=function(n){var r=document.createElement("div");r.id="quill",document.getElementById("quill_container").innerHTML="",document.getElementById("quill_container").appendChild(r),l=new Quill("#quill",{modules:{toolbar:[["bold","italic","underline","strike"],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["link","image"],["clean"]],imageResize:{}},theme:"snow"}),void 0!=n?(e.selected=angular.copy(e.news[n]),l.container.firstChild.innerHTML=e.selected.content):(l.container.firstChild.innerHTML="",e.selected={title:"",content:"",order:e.news.length,timestamp:0,author:s.user.uid})};var t=function(){var n={};n[s.user.course]=Date.now(),Cipressus.db.update(n,"metadata/updates/news").then(function(){console.log("Actualización de metadata"),c={news:e.news,authors:e.users,last_update:Date.now()},r.set("newsData_"+s.user.course,c)})["catch"](function(e){console.log(e)})};e.deleteSelected=function(){s.loading=!0,Cipressus.db.set(null,"news/"+s.user.course+"/"+e.selected.key).then(function(n){e.news.splice(e.selected.order,1);var r={};for(k in e.news){e.news[k].order=parseInt(k);var r={};r["news/"+s.user.course+"/"+e.news[k].key+"/order"]=parseInt(k)}Cipressus.db.update(r).then(function(n){M.toast({html:"Listo!",classes:"rounded green darken-3",displayLength:1e3}),s.loading=!1,e.$apply()})["catch"](function(e){s.loading=!1,console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})})["catch"](function(e){s.loading=!1,console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})}),t(),a.close()},e.moveSelected=function(n,r){if(n){if(r>0){s.loading=!0;var a={};a["news/"+s.user.course+"/"+e.news[r].key+"/order"]=e.news[r].order-1,a["news/"+s.user.course+"/"+e.news[r-1].key+"/order"]=e.news[r].order,Cipressus.db.update(a).then(function(n){e.news[r].order=e.news[r].order-1,e.news[r-1].order=e.news[r-1].order+1;var t=angular.copy(e.news[r]);e.news[r]=angular.copy(e.news[r-1]),e.news[r-1]=angular.copy(t),M.toast({html:"Orden actualizado",classes:"rounded green darken-3",displayLength:1e3}),s.loading=!1,e.$apply()})["catch"](function(e){s.loading=!1,console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}}else if(r<e.news.length-1){console.log(e.news[r].key),console.log(e.news[r+1].key),s.loading=!0;var a={};a["news/"+s.user.course+"/"+e.news[r].key+"/order"]=e.news[r].order+1,a["news/"+s.user.course+"/"+e.news[r+1].key+"/order"]=e.news[r].order,Cipressus.db.update(a).then(function(n){e.news[r].order=e.news[r].order+1,e.news[r+1].order=e.news[r+1].order-1;var t=angular.copy(e.news[r]);e.news[r]=angular.copy(e.news[r+1]),e.news[r+1]=angular.copy(t),M.toast({html:"Orden actualizado",classes:"rounded green darken-3",displayLength:1e3}),s.loading=!1,e.$apply()})["catch"](function(e){s.loading=!1,console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}t()},e.saveSelected=function(){if(s.loading=!0,e.scheduledNew){var n=document.getElementById("schedule_date").value,r=document.getElementById("schedule_time").value,a=1e3*moment(r+" "+n,"HH:mm YYYY-MM-DD").unix();if(!a)return M.toast({html:"Ingrese fecha de publicación programada",classes:"rounded red",displayLength:2e3}),void(s.loading=!1);e.selected.timestamp=a}else e.selected.timestamp=Date.now();if(e.selected.content=l.container.firstChild.innerHTML.replace(new RegExp("<img src=","g"),"<img class='responsive-img' src="),e.selected.key){var d=e.selected.key;e.selected.key=null,Cipressus.db.update(e.selected,"news/"+s.user.course+"/"+d).then(function(n){e.selected.key=d;var r=e.news.findIndex(function(e){return e.key==d});e.news[r]=angular.copy(e.selected),M.toast({html:"Comunicado actualizado",classes:"rounded green darken-3",displayLength:1500}),o.close(),s.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"Ocurrió un error al intentar guardar",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()})}else s.loading=!0,Cipressus.db.push(e.selected,"news/"+s.user.course).then(function(n){e.users[s.user.uid]||(e.users[s.user.uid]={name:s.user.name,avatar:s.user.avatar}),e.selected.key=n.key,e.news.push(e.selected),o.close(),s.loading=!1,e.$apply()})["catch"](function(n){console.log(n),M.toast({html:"Ocurrió un error al intentar guardar",classes:"rounded red",displayLength:2e3}),s.loading=!1,e.$apply()});t()},M.Modal.init(document.getElementById("view_modal"),{preventScrolling:!1});var a=M.Modal.init(document.getElementById("confirm_modal"),{preventScrolling:!1,dismissible:!1}),o=M.Modal.init(document.getElementById("edit_modal"),{preventScrolling:!1,dismissible:!1});e.selected={},e.scheduledNew=!1;var l,d=function(){e.news=[];var n=[];Cipressus.db.getSorted("news/"+s.user.course,"order").then(function(t){if(t.forEach(function(s){var r=s.val();r.content=Cipressus.utils.quillToHTML(r.content),r.key=s.key,-1==n.indexOf(r.author)&&n.push(r.author),e.news.push(r)}),e.users={},n.length>0){var a=[];for(var o in n)a.push(Cipressus.db.get("users_public/"+n[o]));Promise.all(a).then(function(t){for(var a in t)e.users[n[a]]=t[a];c={news:e.news,authors:e.users,last_update:Date.now()},r.set("newsData_"+s.user.course,c),s.loading=!1,s.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})}else s.loading=!1,s.$apply()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})};Cipressus.utils.activityCntr(s.user.uid,"editor")["catch"](function(e){console.log(e)});var c=r.get("newsData_"+s.user.course);c?(e.news=c.news,e.users=c.authors,Cipressus.db.get("metadata/updates/news/"+s.user.course).then(function(e){c.last_update<e?d():(s.loading=!1,s.$apply())})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3})})):d()}]);
app.controller("profile",["$scope","$rootScope","$location",function(e,a,t){return a.userLogged?(e.editingReady=!1,document.getElementById("imgInput").addEventListener("change",function(){a.loading=!0,e.$apply();var t=document.getElementById("imgInput").files[0],n=new FileReader;n.onloadend=function(){e.newAvatar=n.result,e.avatarFile=t,e.newProfilePic=!0,a.loading=!1,e.$apply()},t&&n.readAsDataURL(t)}),e.uploadPic=function(){document.getElementById("imgInput").click()},e.saveForm=function(){a.loading=!0;var t={name:document.getElementById("inputName").value,secondName:document.getElementById("inputSecondName").value,lu:document.getElementById("inputLU").value,degree:document.getElementById("inputDegree").value,partners:[]};if(""==t.name||""==t.secondName||""==t.lu||""==t.degree)return console.log("Uno de los campos queda vacio."),M.toast({html:"Complete todos los campos",classes:"rounded red",displayLength:2500}),void(a.loading=!1);var n=function(a){for(var t in e.users)if(e.users[t].name+" "+e.users[t].secondName==a)return t};if(""!=document.getElementById("partner1").value){var r=n(document.getElementById("partner1").value);if(!r)return M.toast({html:"Nombre de usuario no válido",classes:"rounded red",displayLength:2500}),void(a.loading=!1);t.partners.push(r)}if(""!=document.getElementById("partner2").value){var r=n(document.getElementById("partner2").value);if(!r)return M.toast({html:"Nombre de usuario no válido",classes:"rounded red",displayLength:2500}),void(a.loading=!1);t.partners.push(r)}if(2==t.partners.length&&t.partners[0]==t.partners[1])return M.toast({html:"Nombres de compañeros iguales",classes:"rounded red",displayLength:2500}),void(a.loading=!1);var s=function(){Cipressus.db.update(t,"users_public/"+a.user.uid).then(function(n){M.toast({html:"Datos actualizados!",classes:"rounded green darken-3",displayLength:2500}),a.user.name=t.name,a.user.secondName=t.secondName,a.user.lu=t.lu,a.user.degree=t.degree,a.user.partners=t.partners,a.loading=!1,e.edit=!1,e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un problema al actualizar los datos",classes:"rounded red",displayLength:2500}),a.loading=!1,e.$apply()})};if(e.newProfilePic){var o=function(){var n=Cipressus.utils.generateFileName(25)+"."+e.avatarFile.name.split(".")[1];Cipressus.storage.put(e.avatarFile,"Images",n).then(function(e){t.avatar=e.url,t.avatarFilename=n,a.user.avatar=e.url,a.user.avatarFilename=n,s()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al actualizar imagen",classes:"rounded red",displayLength:2500}),a.loading=!1,e.$apply()})};a.user.avatarFilename?Cipressus.storage["delete"](a.user.avatarFilename,"Images").then(function(e){o()})["catch"](function(e){console.log(e),M.toast({html:"Ocurrió un error al actualizar imagen",classes:"rounded red",displayLength:2500}),o()}):o()}else s()},e.enableEditing=function(){e.editingReady?e.edit=!0:(a.loading=!0,Cipressus.db.get("users_private").then(function(t){var n={};for(var r in e.users)t[r].course!=a.user.course||t[r].admin||r==a.user.uid||(n[e.users[r].name+" "+e.users[r].secondName]=e.users[r].avatar);M.Autocomplete.init(document.querySelectorAll(".autocomplete"),{data:n}),a.loading=!1,e.edit=!0,e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),a.loading=!1,e.$apply()}))},a.loading=!0,a.sidenav.close(),e.edit=!1,e.newProfilePic=!1,e.created=a.user.enrolled>0?moment(a.user.enrolled).format("DD/MM/YYYY HH:mm"):"(Aún no aprobado)",e.newAvatar=a.user.avatar,M.Tooltip.init(document.querySelectorAll(".tooltipped"),{}),Cipressus.utils.activityCntr(a.user.uid,"profile")["catch"](function(e){console.log(e)}),void Cipressus.db.get("users_public").then(function(t){e.users=t,document.getElementById("inputName").value=a.user.name,document.getElementById("inputSecondName").value=a.user.secondName,document.getElementById("inputLU").value=a.user.lu,document.getElementById("inputDegree").value=a.user.degree,a.user.partners&&(a.user.partners[0]&&(document.getElementById("partner1").value=e.users[a.user.partners[0]].name+" "+e.users[a.user.partners[0]].secondName),a.user.partners[1]&&(document.getElementById("partner2").value=e.users[a.user.partners[1]].name+" "+e.users[a.user.partners[1]].secondName)),M.FormSelect.init(document.querySelectorAll("select"),{}),M.updateTextFields(),a.loading=!1,e.$apply()})["catch"](function(t){console.log(t),M.toast({html:"Ocurrió un error al acceder a la base de datos",classes:"rounded red",displayLength:2e3}),a.loading=!1,e.$apply()})):void t.path("/login")}]);
//# sourceMappingURL=maps/main-b9e5a57ab2.js.map